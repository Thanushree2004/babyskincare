<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Upload - Smart Baby Skin Scanner</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#eaf7ff;margin:0}
    nav{background:#39a84b;color:#fff;padding:12px 20px;display:flex;align-items:center;justify-content:space-between}
    .nav-left{display:flex;gap:18px;align-items:center}
    .logo{font-weight:700}
    .nav-link{color:#fff;text-decoration:none;font-weight:600}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:#2e8b3a;color:#fff;border:0;padding:8px 12px;border-radius:6px;cursor:pointer}
    .btn.alt{background:#d32f2f}
    .container{max-width:1100px;margin:36px auto;padding:28px;background:#fff;border-radius:12px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    .row{display:flex;gap:30px;align-items:flex-start;justify-content:center;flex-wrap:wrap}
    .card{background:#fbfbfb;border-radius:10px;padding:18px;width:340px;box-shadow:0 6px 18px rgba(0,0,0,0.06);min-height:140px}
    h1{text-align:center;margin-top:0;color:#234}
    #preview img{max-width:100%;border-radius:10px}
    .rash-tab{display:inline-block;padding:10px 16px;border-radius:20px;font-weight:700}
    .rash-healthy{background:#e7f9ed;color:#1b5e20}
    .rash-mild{background:#e6f3ff;color:#0d47a1}
    .rash-fungal{background:#f5e9ff;color:#4a148c}
    .rash-infection{background:#fdeaea;color:#b71c1c}
    .rash-other{background:#f2f2f2;color:#37474f}
    ul{padding-left:18px}
    .small{font-size:14px;color:#444}
    .camera-modal{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center}
    .camera-card{background:#fff;padding:14px;border-radius:8px;max-width:520px;width:94%}
    @media (max-width:800px){.row{flex-direction:column;align-items:center}}
  </style>
</head>
<body>
  <nav>
    <div class="nav-left">
      <div class="logo">üë∂ Baby Skin Care</div>
      <a class="nav-link" href="home.html" data-en="Home" data-kn="‡≤Æ‡≥Å‡≤ñ‡≤™‡≥Å‡≤ü">Home</a>
      <a class="nav-link" href="upload.html" data-en="Upload" data-kn="‡≤Ö‡≤™‡≥ç‚Äå‡≤≤‡≥ã‡≤°‡≥ç">Upload</a>
      <a class="nav-link" href="about.html" data-en="About" data-kn="‡≤¨‡≤ó‡≥ç‡≤ó‡≥Ü">About</a>
      <a class="nav-link" href="contact_help.html" data-en="Contact & Help" data-kn="‡≤∏‡≤Ç‡≤™‡≤∞‡≥ç‡≤ï & ‡≤∏‡≤π‡≤æ‡≤Ø">Contact & Help</a>
      <a class="nav-link" href="#" onclick="openDashboard()" data-en="Dashboard ‚Üí" data-kn="‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç ‚Üí">Dashboard ‚Üí</a>
    </div>
    <div class="controls">
      <select id="lang" style="padding:6px;border-radius:6px">
        <option value="en">English</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
      </select>
      <button class="btn" id="logoutBtn">Logout</button>
    </div>
  </nav>

  <div class="container">
    <h1 data-en="Smart Baby Rash Detector" data-kn="‡≤∏‡≥ç‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ü‡≥ç ‡≤¨‡≥á‡≤¨‡≤ø ‡≤∞‡≤æ‡≤∂‡≤ø ‡≤™‡≤§‡≥ç‡≤§‡≥Ü‡≤ó‡≤æ‡≤∞">Smart Baby Rash Detector</h1>

    <div class="row">
      <div class="card" style="text-align:center">
        <h2 data-en="Upload Image" data-kn="‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ö‡≤™‡≥ç‚Äå‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">Upload Image</h2>
        <input id="fileInput" type="file" accept="image/*"><br>
        <div style="margin-top:12px">
          <button id="cameraBtn" class="btn" data-en="Use Camera" data-kn="‡≤ï‡≥ç‡≤Ø‡≤æ‡≤Æ‡≤∞‡≤æ ‡≤¨‡≤≥‡≤∏‡≤ø">Use Camera</button>
          <button id="checkBtn" class="btn" data-en="Check Rash" data-kn="‡≤∞‡≤æ‡≤∂‡≤ø ‡≤™‡≤∞‡≤ø‡≤∂‡≥Ä‡≤≤‡≤®‡≥Ü">Check Rash</button>
        </div>
        <div style="margin-top:10px">
          <button id="resetBtn" class="btn alt" data-en="Reset" data-kn="‡≤Æ‡≤∞‡≥Å‡≤π‡≥ä‡≤Ç‡≤¶‡≤ø‡≤∏‡≤ø">Reset</button>
        </div>
      </div>

      <div class="card" id="preview" style="display:none">
        <h2 data-en="Image Preview" data-kn="‡≤ö‡≤ø‡≤§‡≥ç‡≤∞ ‡≤Æ‡≥Å‡≤®‡≥ç‡≤®‡≥ã‡≤ü">Image Preview</h2>
        <img id="previewImg" src="">
      </div>

      <div class="card" id="result" style="display:none">
        <h2 data-en="Prediction Result" data-kn="‡≤Ö‡≤Ç‡≤¶‡≤æ‡≤ú‡≥Å ‡≤´‡≤≤‡≤ø‡≤§‡≤æ‡≤Ç‡≤∂">Prediction Result</h2>
        <div style="margin:12px 0">
          <div id="rashTab" class="rash-tab rash-other">Rash: <span id="rashType">-</span></div>
          <div class="small" style="margin-top:8px" id="confLine">Confidence: <strong id="confVal">-</strong></div>
        </div>
        <div style="margin-top:8px">
          <label for="assignBabySelect" class="small" data-en="Assign to baby (optional)" data-kn="‡≤∂‡≤ø‡≤∂‡≥Å‡≤µ‡≤ø‡≤ó‡≥Ü ‡≤®‡≤ø‡≤Ø‡≥Å‡≤ï‡≥ç‡≤§ ‡≤Æ‡≤æ‡≤°‡≤ø (‡≤ê‡≤ö‡≥ç‡≤õ‡≤ø‡≤ï)">Assign to baby (optional)</label>
          <div style="margin-top:6px">
            <select id="assignBabySelect" style="width:100%;padding:8px;border-radius:6px;border:1px solid #e6e9ef">
              <option value="">-- No baby / Don't assign --</option>
            </select>
          </div>
        </div>
        <h3 data-en="Care Tips:" data-kn="‡≤™‡≥ã‡≤∑‡≤£‡≥Ü ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≥Å:">Care Tips:</h3>
        <ul id="careList"></ul>
        <h3 data-en="Prevention:" data-kn="‡≤§‡≤°‡≥Ü‡≤ó‡≤ü‡≥ç‡≤ü‡≥Å‡≤µ‡≤ø‡≤ï‡≥Ü:">Prevention:</h3>
        <ul id="prevList"></ul>
      </div>
    </div>
  </div>

  <div class="camera-modal" id="cameraModal">
    <div class="camera-card">
      <video id="video" autoplay playsinline style="width:100%;border-radius:6px;background:#000"></video>
      <div style="margin-top:8px;text-align:right">
        <button id="capture" class="btn">Capture</button>
        <button id="closeCam" class="btn alt">Close</button>
      </div>
      <canvas id="canvas" style="display:none"></canvas>
    </div>
  </div>

<script>
  const BACKEND = "http://127.0.0.1:5000";
  const fileInput = document.getElementById('fileInput');
  const preview = document.getElementById('preview');
  const previewImg = document.getElementById('previewImg');
  const result = document.getElementById('result');
  const rashType = document.getElementById('rashType');
  const confVal = document.getElementById('confVal');
  const careList = document.getElementById('careList');
  const prevList = document.getElementById('prevList');
  const checkBtn = document.getElementById('checkBtn');
  const resetBtn = document.getElementById('resetBtn');
  const cameraBtn = document.getElementById('cameraBtn');
  const cameraModal = document.getElementById('cameraModal');
  const video = document.getElementById('video');
  const captureBtn = document.getElementById('capture');
  const closeCam = document.getElementById('closeCam');
  const canvas = document.getElementById('canvas');
  const langSelect = document.getElementById('lang');
  const logoutBtn = document.getElementById('logoutBtn');

  // simple nav
  function openDashboard(){ const role=localStorage.getItem('role'); if(role==='doctor') location.href='doctor_dashboard.html'; else location.href='parent_dashboard.html'; }
  logoutBtn.addEventListener('click', ()=>{ localStorage.removeItem('token'); localStorage.removeItem('role'); location.href='login.html'; });

  // language apply for static labels
  function applyLang(l){
    document.querySelectorAll('[data-en]').forEach(el=>{
      el.textContent = l==='kn' ? (el.getAttribute('data-kn')||el.getAttribute('data-en')) : el.getAttribute('data-en');
    });
  }
  langSelect.value = localStorage.getItem('lang') || 'en';
  applyLang(langSelect.value);
  langSelect.addEventListener('change', ()=>{ localStorage.setItem('lang', langSelect.value); applyLang(langSelect.value); });

  // preview helpers
  function showPreview(src){
    previewImg.src = src;
    preview.style.display = 'block';
  }
  function hidePreview(){ previewImg.src=''; preview.style.display='none'; }

  fileInput.addEventListener('change', ()=> {
    const f = fileInput.files[0];
    if (!f) return;
    const reader = new FileReader();
    reader.onload = e => {
      showPreview(e.target.result);
      // new image selected -> clear any previous stored prediction
      try { sessionStorage.removeItem('lastPrediction'); sessionStorage.removeItem('lastPreview'); } catch(e){}
    };
    reader.readAsDataURL(f);
    // clear any previous result
    result.style.display='none';
  });

  // camera
  let stream = null;
  cameraBtn.addEventListener('click', async ()=>{
    try{
      stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:'environment'}, audio:false});
      video.srcObject = stream;
      cameraModal.style.display = 'flex';
    }catch(e){ alert('Camera unavailable: '+ (e.message||e)); }
  });
  captureBtn.addEventListener('click', ()=>{
    const w = video.videoWidth || 640, h = video.videoHeight || 480;
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(video,0,0,w,h);
    canvas.toBlob(blob => {
      // convert blob -> dataURL so preview can be persisted across reloads
      const reader = new FileReader();
      reader.onload = (ev) => {
        const dataUrl = ev.target.result;
        showPreview(dataUrl);
        // keep blob for upload but keep dataURL for persistence/restore
        window._captureBlob = blob;
        window._captureDataURL = dataUrl;
        // clear any previous stored prediction (new image)
        try { sessionStorage.removeItem('lastPrediction'); sessionStorage.removeItem('lastPreview'); } catch(e){}
      };
      reader.readAsDataURL(blob);
      cameraModal.style.display = 'none';
      stopCamera();
    }, 'image/png');
  });
  closeCam.addEventListener('click', ()=>{ cameraModal.style.display='none'; stopCamera(); });
  function stopCamera(){ if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; } }

  // reset (also clear stored prediction/preview)
  resetBtn.addEventListener('click', ()=>{
    fileInput.value=''; window._captureBlob=null; window._captureDataURL = null;
    hidePreview();
    result.style.display='none';
    try { sessionStorage.removeItem('lastPrediction'); sessionStorage.removeItem('lastPreview'); } catch(e){}
  });

  // style rash tab
  function styleTab(type){
    const t = (type||'').toLowerCase();
    const tab = document.getElementById('rashTab');
    tab.className = 'rash-tab rash-other';
    if(t==='healthy') tab.className='rash-tab rash-healthy';
    else if(['diaper_rash','heat_rash','eczema_rash'].includes(t)) tab.className='rash-tab rash-mild';
    else if(['ringworm','candidiases'].includes(t)) tab.className='rash-tab rash-fungal';
    else if(['impetigo','chickenpox'].includes(t)) tab.className='rash-tab rash-infection';
  }

  // send to backend
  checkBtn.addEventListener('click', async ()=>{ 
    let file = fileInput.files[0] || window._captureBlob;
    if(!file){ alert(langSelect.value==='kn' ? '‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤ï‡≥ç‡≤Ø‡≤æ‡≤Æ‡≤∞‡≤æ ‡≤¨‡≤≥‡≤∏‡≤ø' : 'Choose or capture an image first'); return; }
    checkBtn.disabled=true; checkBtn.textContent = langSelect.value==='kn' ? '‡≤µ‡≤ø‡≤∂‡≥ç‡≤≤‡≥á‡≤∑‡≤ø‡≤∏‡≤ø‡≤ï‡≥Ü‡≥Ç‡≤Ç‡≤°‡≥Å...' : 'Analyzing...';
    try{
      const fd = new FormData();
      if (file instanceof Blob && !file.name) file = new File([file], 'capture.png', {type:'image/png'});
      fd.append('file', file);
      const res = await fetch(`${BACKEND}/predict?lang=${encodeURIComponent(langSelect.value)}`, { method:'POST', body:fd });
      if(!res.ok){
        const txt = await res.text();
        throw new Error(txt || `Server ${res.status}`);
      }
      const j = await res.json();
      // display fields
      const type = j.rash_type || j.label || 'unknown';
      let conf = j.confidence ?? j.confidence_raw ?? j.score ?? 0;
      if(conf <= 1) conf = conf*100;
      rashType.textContent = type;
      confVal.textContent = `${conf.toFixed(2)}%`;
      styleTab(type);
      careList.innerHTML=''; prevList.innerHTML='';
      (j.care_tips||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent = t; careList.appendChild(li); });
      (j.prevention_tips||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent = t; prevList.appendChild(li); });
      if((j.care_tips||[]).length===0){ const li=document.createElement('li'); li.textContent = langSelect.value==='kn' ? '‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤™‡≥ã‡≤∑‡≤£‡≥Ü ‡≤∏‡≥Ç‡≤ö‡≤®‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤≤‡≤≠‡≥ç‡≤Ø‡≤µ‡≤ø‡≤≤‡≥ç‡≤≤' : 'No care tips available'; careList.appendChild(li); }
      // show result and persist to sessionStorage (so reload won't hide it)
      result.style.display='block';
      try {
        const previewToSave = previewImg.src || window._captureDataURL || '';
        sessionStorage.setItem('lastPrediction', JSON.stringify({ rash_type: type, confidence: conf, care_tips: j.care_tips||[], prevention_tips: j.prevention_tips||[] }));
        if (previewToSave) sessionStorage.setItem('lastPreview', previewToSave);
      } catch (e){ console.warn('persist prediction failed', e); }

      // --- new: save scan record to backend (with image + prediction details) ---
      try {
        const saved = await saveScanToServer(j, file);
        if (saved) {
          // store for dashboard to pick up quickly
          try { sessionStorage.setItem('lastSavedScan', JSON.stringify(saved)); } catch(e){}
          // Ask to open dashboard to view the saved scan
          if (confirm((langSelect.value==='kn' ? '‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç ‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü. ‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç‚Äå‡≤ó‡≥Ü ‡≤§‡≥Ü‡≤∞‡≤≥‡≤≤‡≥Å ‡≤á‡≤ö‡≥ç‡≤õ‡≤ø‡≤∏‡≥Å‡≤µ‡≤ø‡≤∞‡≤æ?' : 'Scan saved. Open Dashboard to view it?'))) {
            window.location.href = 'parent_dashboard.html';
          }
        }
      } catch(e){ console.warn('saveScanToServer call failed', e); }
      // ---------------------------------------------------------------------

    }catch(e){
      console.error(e);
      alert((langSelect.value==='kn' ? '‡≤Ö‡≤Ç‡≤¶‡≤æ‡≤ú‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤: ' : 'Prediction failed: ') + (e.message||e));
    }finally{
      checkBtn.disabled=false; checkBtn.textContent = langSelect.value==='kn' ? '‡≤∞‡≤æ‡≤∂‡≤ø ‡≤™‡≤∞‡≤ø‡≤∂‡≥Ä‡≤≤‡≤®‡≥Ü' : 'Check Rash';
    }
  });
  
  // restore prediction on load if present (keeps result visible after incidental reloads)
  (function init(){
    applyLang(langSelect.value);
    // load babies for the logged-in parent (so scans can be assigned)
    try { loadBabiesForParent(); } catch(e){ console.warn('load babies failed', e); }
    try {
      const pred = sessionStorage.getItem('lastPrediction');
      const prev = sessionStorage.getItem('lastPreview');
      if (prev) { showPreview(prev); }
      if (pred) {
        const data = JSON.parse(pred);
        const type = data.rash_type || '-';
        const conf = data.confidence || 0;
        rashType.textContent = type;
        confVal.textContent = `${(typeof conf === 'number' ? conf : parseFloat(conf)).toFixed(2)}%`;
        styleTab(type);
        careList.innerHTML=''; prevList.innerHTML='';
        (data.care_tips||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent = t; careList.appendChild(li); });
        (data.prevention_tips||[]).forEach(t=>{ const li=document.createElement('li'); li.textContent = t; prevList.appendChild(li); });
        result.style.display='block';
      } else {
        hidePreview();
        result.style.display='none';
      }
    } catch(e) { console.warn('restore failed', e); hidePreview(); result.style.display='none'; }
  })();

  // load babies for parent and populate assign select
  async function loadBabiesForParent(){
    const parentId = localStorage.getItem('user_id') || '';
    const token = localStorage.getItem('token') || localStorage.getItem('access_token');
    if (!parentId) return;
    try {
      const headers = {};
      if (token) headers['Authorization'] = `Bearer ${token}`;
      const res = await fetch(`${BACKEND}/api/babies/${parentId}`, { headers });
      if (!res.ok) return;
      const data = await res.json();
      const sel = document.getElementById('assignBabySelect');
      // clear non-empty options except first
      sel.innerHTML = '<option value="">-- No baby / Don\'t assign --</option>';
      if (Array.isArray(data) && data.length){
        data.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.text = `${b.name || ('Baby ' + b.id)} ${b.date_of_birth? '‚Ä¢ '+b.date_of_birth : ''}`;
          sel.appendChild(opt);
        });
      }
    } catch (e){ console.warn('loadBabiesForParent error', e); }
  }

  // Save scan (image + prediction) to backend so dashboard can show it.
  async function saveScanToServer(pred, fileBlob){
    const token = localStorage.getItem('token') || localStorage.getItem('access_token');
    try {
      const fd = new FormData();
      // ensure file is a File object with name
      let file = fileBlob;
      if (file instanceof Blob && !file.name) file = new File([file], 'capture.png', { type: 'image/png' });
      fd.append('file', file);
      // attach parent_id from logged-in user if available
      const parentId = localStorage.getItem('user_id') || '';
      if (parentId) fd.append('parent_id', parentId);
      // optional: use baby selected in this upload UI (assign scan to baby)
      const babySel = document.getElementById('assignBabySelect');
      const babyId = babySel ? (babySel.value || '') : (localStorage.getItem('selected_baby_id') || '');
      if (babyId) fd.append('baby_id', babyId);
      fd.append('rash_type', pred.rash_type || pred.label || '');
      fd.append('confidence', String(pred.confidence ?? pred.score ?? 0));
      fd.append('care_tips', JSON.stringify(pred.care_tips || []));
      fd.append('prevention_tips', JSON.stringify(pred.prevention_tips || []));
      fd.append('raw_response', JSON.stringify(pred || {}));

      const headers = {};
      if (token) headers['Authorization'] = `Bearer ${token}`;

      const saveRes = await fetch(`${BACKEND}/api/scans`, {
        method: 'POST',
        headers,
        body: fd
      });

      if (!saveRes.ok) {
        const txt = await saveRes.text();
        console.warn('Failed to save scan:', txt || saveRes.status);
        return null;
      }
      const saved = await saveRes.json();
      console.log('Scan saved on server', saved);
      // optionally persist saved scan id locally
      try { sessionStorage.setItem('lastSavedScan', JSON.stringify(saved)); } catch(e) {}
      return saved;
    } catch(err){
      console.warn('saveScanToServer error', err);
      return null;
    }
  }
</script>
</body>
</html>
