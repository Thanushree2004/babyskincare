<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title data-en="Parent Dashboard" data-kn="‡≤™‡≥ã‡≤∑‡≤ï‡≤∞ ‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç">Parent Dashboard</title>

  <style>
    :root{
      --primary:#1166ee;
      --accent:#4CAF50;
      --bg:#f6fbff;
      --card:#fff;
      --muted:#6b7280;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:#111827; }

    /* Topbar */
    .topbar{ height:68px; display:flex; align-items:center; gap:16px; padding:0 20px; background:#fff; box-shadow:var(--shadow); position:sticky; top:0; z-index:90; }
    .brand{ display:flex; gap:12px; align-items:center; font-weight:700;}
    .logo{ width:46px; height:46px; border-radius:10px; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow:0 3px 8px rgba(0,0,0,0.08); }
    .top-actions{ margin-left:auto; display:flex; gap:12px; align-items:center;}

    .btn{ background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.ghost{ background:#fff; color:#111; border:1px solid #e6e9ef; box-shadow:none; }
    .btn.secondary{ background:#10b981; }

    /* Layout */
    .layout{ display:flex; gap:24px; padding:26px; max-width:1200px; margin:20px auto; align-items:flex-start; }

    /* Sidebar */
    .sidebar{ width:260px; background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); position:sticky; top:88px; height:calc(100vh - 120px); display:flex; flex-direction:column; gap:12px; }
    .sidebar .menu-title{ font-weight:700; color:#0f1724; margin-bottom:6px; }
    .nav-item{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; color:#374151; cursor:pointer; text-decoration:none; }
    .nav-item:hover{ background:#f3f6ff; color:var(--primary); }
    .nav-item.active{ background:#eaf2ff; color:var(--primary); font-weight:700; }
    .small-muted{ font-size:13px; color:var(--muted); }

    /* Main */
    .main{ flex:1; display:flex; flex-direction:column; gap:18px; min-height:60vh; }
    .card{ background:var(--card); padding:18px; border-radius:12px; box-shadow:var(--shadow); }
    .card.row{ display:flex; gap:18px; flex-wrap:wrap; }
    .card.small{ flex:0 0 220px; display:flex; flex-direction:column; gap:8px; justify-content:center; }
    .muted{ color:var(--muted); font-size:13px; }

    /* baby list / history */
    .baby-list{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .baby-row{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:10px; background:#fbfdff; border:1px solid #f1f5f9; }
    .baby-row .meta{ font-size:13px; color:var(--muted); }

    /* doctors list */
    .doctor-card{ display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; border:1px solid #eef3ff; background:#fff; }
    .doctor-photo{ width:56px; height:56px; border-radius:8px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-weight:700; color:#334155; }

    /* status pill (used in consult list) */
    .status-pill { padding:6px 10px; border-radius:999px; font-weight:700; color:#fff; display:inline-block; }
    .status-pill.pending { background:#f39c12; }
    .status-pill.accepted { background:#10b981; }
    .status-pill.rejected { background:#ef4444; }

    /* responsive */
    @media (max-width:960px){
      .layout{ padding:12px; margin:12px; flex-direction:column; max-width:960px; }
      .sidebar{ width:100%; height:auto; position:relative; top:0; flex-direction:row; align-items:center; overflow:auto; padding:12px; gap:8px; }
      .sidebar .menu-title{ display:none; }
      .card.small{ flex:1 1 48%; }
    }

    /* Chat floating button */
    .chat-fab{ position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%; background:var(--primary); color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 20px rgba(17,102,238,0.18); cursor:pointer; z-index:200; }
    .chat-fab[hidden]{ display:none; }

    /* small thumb */
    .scan-thumb{ width:64px; height:48px; object-fit:cover; border-radius:8px; }
    .filter-select{ width:100%; padding:8px; border-radius:8px; border:1px solid #e6e9ef; margin-bottom:8px; }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">üë∂</div>
      <div>
        <div style="font-size:14px" data-en="Smart Baby Skin Scanner" data-kn="‡≤∏‡≥ç‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ü‡≥ç ‡≤¨‡≥á‡≤¨‡≤ø ‡≤∏‡≥ç‡≤ï‡≤ø‡≤®‡≥ç ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≤∞‡≥ç">Smart Baby Skin Scanner</div>
        <div style="font-size:12px;color:var(--muted)" id="welcomeText">Welcome</div>
      </div>
    </div>

    <div class="top-actions">
      <select id="languageSwitcher">
        <option value="en">English</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
      </select>

      <button class="btn ghost" onclick="openDashboard()" data-en="Dashboard" data-kn="‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç">Dashboard</button>
      <button class="btn" onclick="logout()" data-en="Logout" data-kn="‡≤≤‡≤æ‡≤ó‡≥å‡≤ü‡≥ç">Logout</button>
    </div>
  </div>

  <!-- LAYOUT -->
  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar" role="navigation" aria-label="Parent menu">
      <div class="menu-title" data-en="Parent Menu" data-kn="‡≤™‡≥ã‡≤∑‡≤ï‡≤∞ ‡≤Æ‡≥Ü‡≤®‡≥Å">Parent Menu</div>

      <div class="nav-item" id="nav_history" onclick="showSection('history')">
        <span>üìú</span><span data-en="Baby History" data-kn="‡≤∂‡≤ø‡≤∂‡≥Å ‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏" style="flex:1">Baby History</span>
      </div>

      <div class="nav-item" id="nav_doctors" onclick="showSection('doctors')">
        <span>üë©‚Äç‚öïÔ∏è</span><span data-en="Doctors List" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞ ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø" style="flex:1">Doctors List</span>
      </div>

      <div class="nav-item" id="nav_profile" onclick="showSection('profile')">
        <span>üë§</span><span data-en="My Profile" data-kn="‡≤®‡≤®‡≥ç‡≤® ‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç" style="flex:1">My Profile</span>
      </div>

      <div class="nav-item" id="nav_status" onclick="showSection('consult_status')">
        <span>üìÖ</span><span data-en="Consultation Status" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø" style="flex:1">Consultation Status</span>
      </div>

      <div style="margin-top:auto; font-size:13px; color:var(--muted);">
        <div data-en="Logged in as" data-kn="‡≤≤‡≤æ‡≤ó‡≤ø‡≤®‡≥ç ‡≤Ü‡≤ó‡≤ø‡≤∞‡≥Å‡≤µ ‡≤™‡≤æ‡≤§‡≥ç‡≤∞">Logged in as</div>
        <strong id="userName">Parent</strong>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- DEFAULT: Baby History (open by default) -->
      <section id="section_history" class="card large">
        <h1 data-en="Baby History" data-kn="‡≤∂‡≤ø‡≤∂‡≥Å ‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏">Baby History</h1>
        <p class="muted" data-en="View all babies, skin scans and previous predictions" data-kn="‡≤é‡≤≤‡≥ç‡≤≤‡≤æ ‡≤∂‡≤ø‡≤∂‡≥Å‡≤ó‡≤≥‡≥Å, ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç‡≤∏‡≥ç ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤π‡≤≥‡≥Ü ‡≤≠‡≤µ‡≤ø‡≤∑‡≥ç‡≤Ø‡≤µ‡≤æ‡≤£‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≥ã‡≤°‡≤ø">View all babies, skin scans and previous predictions</p>

        <div style="margin-top:14px">
          <div class="card row" style="align-items:flex-start; padding:12px;">
            <div style="flex:1;">
              <h3 data-en="Scans" data-kn="‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç‡≤∏‡≥ç">Scans</h3>
              <div id="babyList" class="baby-list"></div>
            </div>

            <div style="width:360px;">
              <h3 data-en="Selected Scan Details" data-kn="‡≤Ü‡≤Ø‡≥ç‡≤¶ ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç ‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≥Å">Selected Scan Details</h3>
              <div id="selectedBabyCard" style="margin-top:8px"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- DOCTORS LIST -->
      <section id="section_doctors" class="card large" style="display:none;">
        <h1 data-en="Doctors" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≥Å">Doctors</h1>
        <p class="muted" data-en="Choose a doctor for consultation" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤æ‡≤ó‡≤ø ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">Choose a doctor for consultation</p>

        <div id="doctorsList" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;"></div>
      </section>

      <!-- DOCTOR PROFILE / BOOKING -->
      <section id="section_docprofile" class="card large" style="display:none;">
        <h1 id="docTitle">Doctor Profile</h1>
        <div id="docProfileArea" style="margin-top:12px;"></div>
      </section>

      <!-- CONSULTATION STATUS (NEW MODERN SYSTEM) -->
      <section id="section_consult_status" class="card large" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          
          <div>
            <h1 data-en="Consultation Status" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø">Consultation Status</h1>
            <p class="muted"
               data-en="Track your booked consultations and their current status"
               data-kn="‡≤®‡≥Ä‡≤µ‡≥Å ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø‡≤¶ ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥ ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤ü‡≥ç‡≤∞‡≥ç‡≤Ø‡≤æ‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">
               Track your booked consultations and their current status
            </p>
          </div>

          <div style="display:flex;gap:10px;align-items:center;">
            <button id="consultRefreshBtn" class="btn ghost"
              data-en="Refresh" data-kn="‡≤Ö‡≤™‡≥ç‚Äå‡≤°‡≥á‡≤ü‡≥ç">Refresh</button>

            <button id="consultCreateBtn" class="btn"
              data-en="Book New" data-kn="‡≤π‡≥ä‡≤∏‡≤¶‡≥Å ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">Book New</button>
          </div>

        </div>

        <div id="consultStatusArea" style="margin-top:16px;">
          
          <!-- Spinner -->
          <div id="consultSpinner" style="display:none;padding:16px;text-align:center;color:var(--muted);">
            <span data-en="Loading consultations‚Ä¶" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü‚Ä¶">
              Loading consultations‚Ä¶
            </span>
          </div>

          <!-- Empty message -->
          <div id="consultEmpty" style="display:none;padding:16px;text-align:center;color:var(--muted);">
            <span data-en="No consultations found." data-kn="‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤.">
              No consultations found.
            </span>
          </div>

          <!-- List container -->
          <div id="consultList" style="display:none;display:flex;flex-direction:column;gap:12px;"></div>

        </div>
      </section>

      <!-- PROFILE -->
      <section id="section_profile" class="card large" style="display:none;">
        <h1 data-en="My Profile" data-kn="‡≤®‡≤®‡≥ç‡≤® ‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç">My Profile</h1>
        <div id="profileArea" style="margin-top:12px"></div>
        <div id="childrenArea" style="margin-top:12px"></div>
      </section>

    </main>

  </div>

  <!-- Chat Floating Button (visible only when chat allowed) -->
  <div id="chatFab" class="chat-fab" title="Open Chat" onclick="openChat()" hidden>üí¨</div>

<script>
/* ============================
   Config & Auth
   ============================ */
const BACKEND = "http://127.0.0.1:5000"; // change if needed
const token = localStorage.getItem("token") || localStorage.getItem("access_token");
const role = localStorage.getItem("role");
const userId = localStorage.getItem("user_id");
const fullName = localStorage.getItem("full_name") || "Parent";
let currentLang = localStorage.getItem("lang") || "en";

/* PAGE PROTECTION (parent only) */
if (!token) {
  window.location.href = "login.html";
}
if (role !== "parent") {
  window.location.href = "doctor_dashboard.html";
}

/* UI init */
document.getElementById("userName").textContent = fullName;
document.getElementById("welcomeText").textContent = currentLang === "en" ? `Welcome, ${fullName}` : `‡≤∏‡≥ç‡≤µ‡≤æ‡≤ó‡≤§, ${fullName}`;
document.getElementById("languageSwitcher").value = currentLang;

/* MULTI-LANGUAGE ENGINE */
function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem("lang", lang);
  document.querySelectorAll("[data-en]").forEach(el => {
    el.textContent = el.getAttribute("data-" + lang);
  });
  document.querySelectorAll("[data-en-placeholder]").forEach(el => {
    el.placeholder = el.getAttribute(`data-${lang}-placeholder`);
  });
  document.getElementById("welcomeText").textContent = lang === "en" ? `Welcome, ${fullName}` : `‡≤∏‡≥ç‡≤µ‡≤æ‡≤ó‡≤§, ${fullName}`;
}
document.getElementById("languageSwitcher").addEventListener("change", e => setLanguage(e.target.value));
setLanguage(currentLang);

/* SECTION NAV */
function hideAllSections() {
  ["history","doctors","docprofile","consult_status","profile"].forEach(s => {
    const el = document.getElementById("section_" + s);
    if (el) el.style.display = "none";
    const nav = document.getElementById("nav_" + s);
    if (nav) nav.classList.remove("active");
  });
}
function showSection(section) {
  hideAllSections();
  document.getElementById("section_" + section).style.display = "";
  const navId = section === "history" ? "nav_history" : section === "doctors" ? "nav_doctors" : section === "profile" ? "nav_profile" : "nav_status";
  const navEl = document.getElementById(navId);
  if (navEl) navEl.classList.add("active");
  if (section === 'history') loadBabies();
  if (section === 'profile') loadParentProfile();
}
function openDashboard() { showSection('history'); }
function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("role");
  localStorage.removeItem("user_id");
  localStorage.removeItem("full_name");
  window.location.href = "login.html";
}
function openChat() {
  window.location.href = `chat.html?user_id=${userId}`;
}

/* ============================
   Backend calls & UI rendering
   ============================ */

/* Helper: fetch JSON with auth */
async function apiFetch(url, options = {}) {
  options.headers = options.headers || {};
  // attach auth header when token available
  if (token) options.headers["Authorization"] = `Bearer ${token}`;
  try {
    const res = await fetch(url, options);
    // always read as text first so we can handle HTML error pages (e.g. login.html)
    const bodyText = await res.text();
    // try parse JSON, otherwise keep raw text
    let data;
    try {
      data = bodyText ? JSON.parse(bodyText) : null;
    } catch (e) {
      data = null;
    }

    // handle non-OK responses specially
    if (!res.ok) {
      // common case: expired / invalid token
      if (res.status === 401) {
        try { localStorage.removeItem('token'); localStorage.removeItem('access_token'); } catch(e){}
        // show friendly message and force login
        alert('Session expired or unauthorized. Please log in again.');
        window.location.href = 'login.html';
        throw new Error(bodyText || JSON.stringify({ status: res.status, statusText: res.statusText }));
      }

      // other errors: throw parsed JSON if available, otherwise raw text
      if (data) throw new Error(JSON.stringify(data));
      throw new Error(bodyText || res.statusText || `HTTP ${res.status}`);
    }

    // success: return parsed JSON when available, otherwise return raw text
    return data !== null ? data : bodyText;
  } catch (err) {
    console.error("API error", err);
    throw err;
  }
}

/* Load babies and populate lists (called at startup) */
let babies = [];
let scans = [];
let selectedBabyId = null;

async function loadBabies() {
  try {
    const data = await apiFetch(`${BACKEND}/api/babies/${userId}`);
    babies = Array.isArray(data) ? data : (data.babies || []);
    renderBabyList();
    if (babies.length) {
      selectedBabyId = babies[0].id;
      renderSelectedBaby(babies[0].id);
    } else {
      selectedBabyId = null;
      renderSelectedBaby(null);
    }
    // update filter if scans already loaded
    populateBabyFilter();
  } catch (e) {
    console.error(e);
    document.getElementById("babyList").innerHTML = `<div class="muted">${currentLang === 'en' ? 'Failed to load babies' : '‡≤∂‡≤ø‡≤∂‡≥Å‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

/* Render baby list area ‚Äî now shows scan filter + scans */
function renderBabyList() {
  const list = document.getElementById("babyList");
  list.innerHTML = "";
  if (!scans.length) {
    const msg = document.createElement('div');
    msg.className = 'muted';
    msg.textContent = currentLang === 'en' ? 'No scans available yet. Upload an image on Upload page.' : '‡≤á‡≤®‡≥ç‡≤®‡≥Ç ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç‡≤∏‡≥ç ‡≤≤‡≤≠‡≥ç‡≤Ø‡≤µ‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤Ö‡≤™‡≥ç‚Äå‡≤≤‡≥ã‡≤°‡≥ç ‡≤™‡≥Å‡≤ü‡≤¶‡≤≤‡≥ç‡≤≤‡≤ø ‡≤ö‡≤ø‡≤§‡≥ç‡≤∞‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ö‡≤™‡≥ç‚Äå‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø.';
    list.appendChild(msg);
    return;
  }

  // If scans exist render them
  renderScanList();
}

/* ----------------------------
   Scans loader & renderer
   ---------------------------- */
async function loadScans() {
  try {
    const data = await apiFetch(`${BACKEND}/api/scans?parent_id=${userId}`);
    // Expecting array or { scans: [...] }
    scans = Array.isArray(data) ? data : (data.scans || []);
    renderScanList();
    populateBabyFilter();
  } catch (e) {
    console.error('Failed to load scans', e);
    scans = [];
    renderScanList();
  }
}

function populateBabyFilter(){
  // No-op: we no longer use a baby filter. Scans are shown for the logged-in account.
  return;
}

function renderScanList(){
  const container = document.getElementById("babyList");
  if(!container) return;

  // no filter: always show all scans for this account
  const filtered = scans.slice();
  container.innerHTML = '';

  if (!filtered.length) {
    const msg = document.createElement('div');
    msg.className = 'muted';
    msg.textContent = currentLang==='en' ? 'No scans found for selected baby.' : '‡≤Ü‡≤Ø‡≥ç‡≤¶ ‡≤∂‡≤ø‡≤∂‡≥Å‡≤ó‡≥Ü ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç‡≤∏‡≥ç ‡≤á‡≤≤‡≥ç‡≤≤.';
    container.appendChild(msg);
    return;
  }

  const wrap = document.createElement('div');
  wrap.style.display = 'flex';
  wrap.style.flexDirection = 'column';
  wrap.style.gap = '8px';

  filtered.forEach(s => {
    const row = document.createElement('div');
    row.className = 'baby-row';
    row.style.justifyContent = 'space-between';
    row.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;flex:1">
        <div>
          ${s.image_url ? `<img src="${escapeHtml(s.image_url)}" class="scan-thumb" />` : `<div style="width:64px;height:48px;border-radius:8px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;color:#334155">IMG</div>`}
        </div>
        <div style="flex:1">
          <div style="font-weight:700">Scan #${escapeHtml(String(s.id || s.scan_id || ''))} ‚Äî ${escapeHtml(s.rash_type || s.label || '')}</div>
          <div class="meta">${escapeHtml(s.created_at || s.created || '')} ‚Ä¢ ${escapeHtml(String(Number(s.confidence || 0)))}%</div>
        </div>
      </div>
      <div style="display:flex;gap:8px">
        <button class="btn ghost" onclick="selectScan(${s.id || s.scan_id})">${currentLang==='en'?'View':'‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤£‡≥Ü‡≤ó‡≥Ü'}</button>
      </div>
    `;
    wrap.appendChild(row);
  });

  container.appendChild(wrap);
}

/* view single scan (open new page or modal) */
function viewScan(scanId) {
  window.location.href = `scan_view.html?scan_id=${scanId}`;
}

/* select baby to show details (kept for compatibility) */
function selectBaby(id) {
  selectedBabyId = id;
  renderSelectedBaby(id);
}

/* select a scan to show its details in the right panel */
function selectScan(scanId) {
  // renderSelectedBaby will try scan endpoint first
  renderSelectedBaby(scanId);
}

/* render selected scan (or fallback to baby history if id refers to a baby) */
async function renderSelectedBaby(id) {
  const area = document.getElementById("selectedBabyCard");
  if (!id) {
    area.innerHTML = `<div class="muted">${currentLang === 'en' ? 'No item selected.' : '‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤ê‡≤ü‡≤Ç ‡≤Ü‡≤Ø‡≥ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤.'}</div>`;
    return;
  }
  try {
    // Try loading a single scan first
    const scan = await apiFetch(`${BACKEND}/api/scans/${id}`);
    // expected fields: id, image_url, rash_type, confidence, care_tips, prevention_tips, created_at
    let html = `<div style="display:flex;flex-direction:column;gap:8px;">`;
    html += `<div style="padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef3ff;display:flex;gap:12px;align-items:center">`;
    if (scan.image_url) html += `<img src="${escapeHtml(scan.image_url)}" style="width:120px;height:90px;object-fit:cover;border-radius:8px" />`;
    html += `<div style="flex:1"><strong>Scan #${escapeHtml(String(scan.id || scan.scan_id || ''))}</strong><div class="muted">${escapeHtml(scan.created_at || scan.created || '')}</div></div>`;
    html += `</div>`;

    html += `<div style="padding:12px;border-radius:8px;border:1px solid #eef3ff;background:#fff;margin-top:8px">`;
    html += `<div style="font-weight:700">${escapeHtml(scan.rash_type || scan.label || '')} <span class="muted">‚Ä¢ ${escapeHtml(String(Number(scan.confidence || 0)))}%</span></div>`;
    if (scan.care_tips && Array.isArray(scan.care_tips) && scan.care_tips.length) {
      html += `<div style="margin-top:8px"><strong>${currentLang==='en'?'Care Tips':'‡≤™‡≥ã‡≤∑‡≤£‡≥Ü ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≥Å'}</strong><ul>`;
      scan.care_tips.forEach(t => { html += `<li>${escapeHtml(t)}</li>`; });
      html += `</ul></div>`;
    }
    if (scan.prevention_tips && Array.isArray(scan.prevention_tips) && scan.prevention_tips.length) {
      html += `<div style="margin-top:8px"><strong>${currentLang==='en'?'Prevention':'‡≤§‡≤°‡≥Ü‡≤ó‡≤ü‡≥ç‡≤ü‡≥Å‡≤µ‡≤ø‡≤ï‡≥Ü'}</strong><ul>`;
      scan.prevention_tips.forEach(t => { html += `<li>${escapeHtml(t)}</li>`; });
      html += `</ul></div>`;
    }
    html += `<div style="margin-top:8px;display:flex;gap:8px"><button class="btn" onclick="viewScan(${scan.id || scan.scan_id})">${currentLang==='en'?'Open Full View':'‡≤™‡≥Ç‡≤∞‡≥ç‡≤£ ‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤£‡≥Ü'}</button></div>`;
    html += `</div>`;

    html += `</div>`;
    area.innerHTML = html;
    return;
  } catch (e) {
    // If scan endpoint failed, try baby history (backwards compatibility)
    try {
      const data = await apiFetch(`${BACKEND}/api/babies/${userId}/${id}/history`); // expects { baby: {...}, scans: [...] }
      let html = `<div style="display:flex;flex-direction:column;gap:8px;">`;
      html += `<div style="padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef3ff"><strong>${escapeHtml(data.baby?.name || 'Baby')}</strong><div class="muted">${escapeHtml(data.baby?.date_of_birth || '')}</div></div>`;
      if (!data.scans || !data.scans.length) {
        html += `<div class="muted" style="padding:12px;border-radius:10px;margin-top:8px">${currentLang==='en'?'No scans found':'‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç‡≤∏‡≥ç ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤'}</div>`;
      } else {
        html += `<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">`;
        data.scans.forEach(s => {
          html += `
            <div class="baby-row">
              <div>
                <strong>${escapeHtml(s.rash_type || '')}</strong>
                <div class="meta">${escapeHtml(s.created_at || '')} ‚Ä¢ ${escapeHtml(String(s.confidence || ''))}%</div>
              </div>
              <div>
                <button class="btn ghost" onclick="viewScan(${s.id})">${currentLang==='en'?'View':'‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤£‡≥Ü‡≤ó‡≥Ü'}</button>
              </div>
            </div>`;
        });
        html += `</div>`;
      }
      html += `</div>`;
      area.innerHTML = html;
      return;
    } catch (err) {
      console.error(err);
      area.innerHTML = `<div class="muted">${currentLang === 'en' ? 'Failed to load details' : '‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
    }
  }
}

/* ----------------------------
   DOCTORS LIST & PROFILE
   ---------------------------- */
let doctors = [];
async function loadDoctors() {
  try {
    const data = await apiFetch(`${BACKEND}/api/doctors`);
    doctors = Array.isArray(data) ? data : [];
    renderDoctorsList();
  } catch (e) {
    console.error(e);
    document.getElementById("doctorsList").innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load doctors':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

function renderDoctorsList() {
  const area = document.getElementById("doctorsList");
  area.innerHTML = "";
  if (!doctors.length) {
    area.innerHTML = `<div class="muted">${currentLang==='en'?'No doctors found':'‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≥Å ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤'}</div>`;
    return;
  }

  doctors.forEach(d => {
    const div = document.createElement("div");
    div.className = "doctor-card";
    div.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;flex:1">
        <div class="doctor-photo">${escapeHtml((d.first_name || 'D').charAt(0))}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(d.first_name)} ${escapeHtml(d.last_name || '')}</div>
          <div class="muted">${escapeHtml(d.specialization || '')} ‚Ä¢ ${escapeHtml(String(d.experience || 'N/A'))} yrs</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn ghost" onclick="viewDoctor(${d.id})">${currentLang==='en'?'View Profile':'‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç ‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤ø‡≤∏‡≤ø'}</button>
        <button class="btn" onclick="bookWithDoctor(${d.id})">${currentLang==='en'?'Book':'‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø'}</button>
      </div>
    `;
    area.appendChild(div);
  });
}

async function viewDoctor(id) {
  try {
    const doc = await apiFetch(`${BACKEND}/api/doctors/${id}`);
    showDoctorProfile(doc);
  } catch (e) {
    console.error(e);
    alert(currentLang==='en'?'Failed to load doctor':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* Show doctor profile in profile section with booking options */
function showDoctorProfile(doc) {
  showSection('docprofile');
  document.getElementById("docTitle").textContent = (currentLang==='en' ? 'Doctor Profile' : '‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞ ‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç') + ` ‚Äî ${doc.first_name} ${doc.last_name || ''}`;
  const area = document.getElementById("docProfileArea");
  area.innerHTML = `
    <div style="display:flex;gap:18px;align-items:flex-start;">
      <div style="width:140px;height:140px;border-radius:12px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-weight:700">${escapeHtml((doc.first_name||'D').charAt(0))}</div>
      <div style="flex:1">
        <h3 style="margin:0">${escapeHtml(doc.first_name)} ${escapeHtml(doc.last_name || '')}</h3>
        <div class="muted">${escapeHtml(doc.specialization || '')} ‚Ä¢ ${escapeHtml(String(doc.experience || ''))} yrs</div>
        <p style="margin-top:10px">${escapeHtml(doc.bio || '')}</p>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" onclick="openBookingForm(${doc.id})" data-en="Book Consultation" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Book Consultation':'‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø'}</button>
          <button class="btn ghost" onclick="showSection('doctors')" data-en="Back to Doctors" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤ø‡≤ó‡≥Ü ‡≤π‡≤ø‡≤Ç‡≤§‡≤ø‡≤∞‡≥Å‡≤ó‡≤ø">${currentLang==='en'?'Back to Doctors':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤ø‡≤ó‡≥Ü ‡≤π‡≤ø‡≤Ç‡≤§‡≤ø‡≤∞‡≥Å‡≤ó‡≤ø'}</button>
        </div>
      </div>
    </div>

    <div id="bookingFormContainer" style="margin-top:18px"></div>
  `;
}

/* Parent profile loader + children management */
async function loadParentProfile(){
  const area = document.getElementById('profileArea');
  area.innerHTML = `<div class="muted">${currentLang==='en'?'Loading profile...':'‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç ‡≤Ö‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...'}</div>`;
  try{
    const profile = await apiFetch(`${BACKEND}/api/parent/profile`);
    const p = profile && profile.user ? profile.user : profile || {};
    const nameVal = escapeHtml(p.full_name || p.first_name || '');
    const phoneVal = escapeHtml(p.phone || '');
    area.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <label data-en="Full name" data-kn="‡≤™‡≥Ç‡≤∞‡≥ç‡≤£ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å">${currentLang==='en'?'Full name':'‡≤™‡≥Ç‡≤∞‡≥ç‡≤£ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å'}</label>
        <input id="parent_full_name" value="${nameVal}" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Phone" data-kn="‡≤¶‡≥Ç‡≤∞‡≤µ‡≤æ‡≤£‡≤ø">${currentLang==='en'?'Phone':'‡≤¶‡≥Ç‡≤∞‡≤µ‡≤æ‡≤£‡≤ø'}</label>
        <input id="parent_phone" value="${phoneVal}" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="saveParentProfile()">${currentLang==='en'?'Save':'‡≤â‡≤≥‡≤ø‡≤∏‡≤ø'}</button>
          <button class="btn ghost" onclick="loadParentProfile()">${currentLang==='en'?'Reload':'‡≤Æ‡≤∞‡≥Å‡≤≤‡≥ã‡≤°‡≥ç'}</button>
        </div>
        <div id="parentProfileMsg" class="muted"></div>
      </div>
    `;
    loadChildren();
  } catch(e){
    console.warn('parent profile not found or failed to fetch, showing empty form', e);
    area.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:8px">
        <div class="muted">${currentLang==='en'?'No profile found. Please enter your details and Save.':'‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤∞‡≤≤‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤â‡≤≥‡≤ø‡≤∏‡≤ø.'}</div>
        <label data-en="Full name" data-kn="‡≤™‡≥Ç‡≤∞‡≥ç‡≤£ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å">${currentLang==='en'?'Full name':'‡≤™‡≥Ç‡≤∞‡≥ç‡≤£ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å'}</label>
        <input id="parent_full_name" value="" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Phone" data-kn="‡≤¶‡≥Ç‡≤∞‡≤µ‡≤æ‡≤£‡≤ø">${currentLang==='en'?'Phone':'‡≤¶‡≥Ç‡≤∞‡≤µ‡≤æ‡≤£‡≤ø'}</label>
        <input id="parent_phone" value="" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="saveParentProfile()">${currentLang==='en'?'Save':'‡≤â‡≤≥‡≤ø‡≤∏‡≤ø'}</button>
          <button class="btn ghost" onclick="loadParentProfile()">${currentLang==='en'?'Reload':'‡≤Æ‡≤∞‡≥Å‡≤≤‡≥ã‡≤°‡≥ç'}</button>
        </div>
        <div id="parentProfileMsg" class="muted"></div>
      </div>
    `;
    loadChildren();
  }
}

async function saveParentProfile(){
  const payload = {
    full_name: document.getElementById('parent_full_name').value.trim(),
    phone: document.getElementById('parent_phone').value.trim()
  };
  const msgEl = document.getElementById('parentProfileMsg');
  try{
    const res = await apiFetch(`${BACKEND}/api/parent/profile`, { method: 'PUT', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
    msgEl.textContent = res.message || (currentLang==='en'?'Saved':'‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
    // update local display and persist full name to localStorage so reload keeps it
    const newName = payload.full_name || (res.user && res.user.full_name) || null;
    if (newName) {
      try { localStorage.setItem('full_name', newName); } catch(e){}
      document.getElementById('userName').textContent = newName;
    }
    // persist phone locally as well so UI shows it on subsequent logins
    const newPhone = payload.phone || (res.user && res.user.phone) || null;
    if (newPhone) {
      try { localStorage.setItem('phone', newPhone); } catch(e){}
    }
    // refresh profile from server to ensure UI reflects persisted state
    try { await loadParentProfile(); } catch(e) { /* ignore refresh errors */ }
  } catch(e){
    console.error(e);
    msgEl.textContent = currentLang==='en'? 'Save failed' : '‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
  }
}

async function loadChildren(){
  const area = document.getElementById('childrenArea');
  area.innerHTML = `<h3 data-en="Your Children" data-kn="‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Æ‡≤ï‡≥ç‡≤ï‡≤≥">${currentLang==='en'?'Your Children':'‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤Æ‡≤ï‡≥ç‡≤ï‡≤≥'}</h3>`;
  try{
    const res = await apiFetch(`${BACKEND}/api/babies/${userId}`);
    const list = Array.isArray(res) ? res : (res.babies || []);
    let html = `<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">`;
    list.forEach(b => {
      html += `<div class="baby-row"><div><strong>${escapeHtml(b.name)}</strong><div class="meta">${escapeHtml(b.date_of_birth || '')}</div></div></div>`;
    });
    html += `</div>`;
    html += `
      <div style="margin-top:12px;padding:12px;border-radius:8px;border:1px solid #eef3ff;background:#fbfdff">
        <h4 data-en="Add Child" data-kn="‡≤Æ‡≤ï‡≥ç‡≤ï‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤ø">${currentLang==='en'?'Add Child':'‡≤Æ‡≤ï‡≥ç‡≤ï‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤ø'}</h4>
        <input id="child_name" placeholder="Name" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
        <input id="child_dob" type="date" style="width:100%;padding:8px;border-radius:8px;border:1px solid #e6e9ef;margin-top:6px" />
        <div style="margin-top:8px"><button class="btn" onclick="addChild()">${currentLang==='en'?'Add':'‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤ø'}</button></div>
        <div id="childMsg" class="muted" style="margin-top:6px"></div>
      </div>
    `;
    area.innerHTML = html;
  } catch(e){
    console.error(e);
    area.innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load children':'‡≤Æ‡≤ï‡≥ç‡≤ï‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

async function addChild(){
  const name = document.getElementById('child_name').value.trim();
  const dob = document.getElementById('child_dob').value;
  const msgEl = document.getElementById('childMsg');
  if (!name || !dob) { msgEl.textContent = currentLang==='en' ? 'Please enter name and date of birth' : '‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤ú‡≤®‡≤® ‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø'; return; }
  try{
    const payload = { parent_id: userId, name, date_of_birth: dob };
    const res = await apiFetch(`${BACKEND}/api/babies`, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
    msgEl.textContent = res.message || (currentLang==='en'?'Child added':'‡≤Æ‡≤ó‡≥Å ‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
    await loadChildren();
    await loadBabies();
    await loadScans();
  } catch(e){
    console.error(e);
    msgEl.textContent = currentLang==='en' ? 'Add failed' : '‡≤∏‡≥á‡≤∞‡≤ø‡≤∏‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
  }
}

/* open booking form for a doctor */
function openBookingForm(doctorId) {
  const container = document.getElementById("bookingFormContainer");
  container.innerHTML = `
    <div style="padding:14px;border-radius:10px;border:1px solid #eef3ff;background:#fbfdff">
      <h4 data-en="Book a Consultation" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Book a Consultation':'‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø'}</h4>

      <label data-en="Select Baby" data-kn="‡≤∂‡≤ø‡≤∂‡≥Å‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Select Baby':'‡≤∂‡≤ø‡≤∂‡≥Å‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø'}</label>
      <select id="bookBabySelect" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"></select>

      <label style="margin-top:8px" data-en="Choose Date" data-kn="‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Choose Date':'‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø'}</label>
      <input id="bookDate" type="date" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"/>

      <label style="margin-top:8px" data-en="Choose Time" data-kn="‡≤∏‡≤Æ‡≤Ø‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Choose Time':'‡≤∏‡≤Æ‡≤Ø‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø'}</label>
      <input id="bookTime" type="time" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"/>

      <label style="margin-top:8px" data-en="Reason (optional)" data_kn="‡≤ï‡≤æ‡≤∞‡≤£ (‡≤ê‡≤ö‡≥ç‡≤õ‡≤ø‡≤ï)" data-kn="‡≤ï‡≤æ‡≤∞‡≤£ (‡≤ê‡≤ö‡≥ç‡≤õ‡≤ø‡≤ï)">${currentLang==='en'?'Reason (optional)':'‡≤ï‡≤æ‡≤∞‡≤£ (‡≤ê‡≤ö‡≥ç‡≤õ‡≤ø‡≤ï)'}</label>
      <textarea id="bookReason" rows="3" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"></textarea>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" onclick="confirmBooking(${doctorId})">${currentLang==='en'?'Confirm Booking':'‡≤¨‡≥Å‡≤ï‡≥ç‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç ‡≤¶‡≥É‡≤¢‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø'}</button>
        <button class="btn ghost" onclick="document.getElementById('bookingFormContainer').innerHTML=''">${currentLang==='en'?'Cancel':'‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≤ø'}</button>
      </div>
    </div>
  `;

  const sel = document.getElementById("bookBabySelect");
  sel.innerHTML = '';
  babies.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b.id; opt.text = b.name;
    sel.appendChild(opt);
  });
}

/* confirm booking API */
async function confirmBooking(doctorId) {
  const babyId = document.getElementById("bookBabySelect").value;
  const date = document.getElementById("bookDate").value;
  const time = document.getElementById("bookTime").value;
  const reason = document.getElementById("bookReason").value.trim();

  if (!babyId || !date || !time) {
    alert(currentLang==='en' ? 'Please select baby, date and time' : '‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤∂‡≤ø‡≤∂‡≥Å, ‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤∏‡≤Æ‡≤Ø ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø');
    return;
  }

  try {
    const payload = {
      parent_id: userId,
      baby_id: babyId,
      doctor_id: doctorId,
      date,
      time,
      reason
    };
    const res = await apiFetch(`${BACKEND}/api/consultations/book`, { method: "POST", body: JSON.stringify(payload), headers: { "Content-Type": "application/json" }});
    alert(res.message || (currentLang==='en' ? 'Booked' : '‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Ü‡≤ó‡≤ø‡≤¶‡≥Ü'));
    await loadConsultStatus();
    document.getElementById("bookingFormContainer").innerHTML = '';
    showSection('consult_status');
  } catch (e) {
    console.error(e);
    alert(currentLang==='en' ? 'Booking failed' : '‡≤¨‡≥Å‡≤ï‡≥ç‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* ----------------------------
   Consultation Status (NEW)
   ---------------------------- */
const consultRefreshBtn = document.getElementById("consultRefreshBtn");
const consultCreateBtn = document.getElementById("consultCreateBtn");
const consultSpinner = document.getElementById("consultSpinner");
const consultEmpty = document.getElementById("consultEmpty");
const consultList = document.getElementById("consultList");

consultRefreshBtn?.addEventListener("click", () => loadConsultStatus());
consultCreateBtn?.addEventListener("click", () => {
  showSection('doctors');
});

async function loadConsultStatus() {
  consultSpinner.style.display = "";
  consultEmpty.style.display = "none";
  consultList.style.display = "none";
  consultList.innerHTML = "";

  try {
    const res = await apiFetch(`${BACKEND}/api/consultations/status/${userId}`);
    const items = Array.isArray(res) ? res : (res.consultations || res.items || []);
    consultSpinner.style.display = "none";

    if (!items || items.length === 0) {
      consultEmpty.style.display = "";
      consultList.style.display = "none";
      return;
    }

    consultEmpty.style.display = "none";
    consultList.style.display = "";

    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "baby-row";
      card.style.justifyContent = "space-between";
      card.style.alignItems = "center";

      const leftHtml = `
        <div style="display:flex;flex-direction:column;gap:6px;">
          <div style="font-weight:700">${escapeHtml(item.doctor_name || item.doctor || (currentLang==='en'?'Doctor':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø'))} ‚Ä¢ ${escapeHtml(item.baby_name || '')}</div>
          <div class="muted">${escapeHtml(item.date || item.requested_at || item.created_at || '')} ‚Ä¢ ${escapeHtml(item.rash_type || '')}</div>
        </div>
      `;

      const rightDiv = document.createElement("div");
      rightDiv.style.display = "flex";
      rightDiv.style.flexDirection = "column";
      rightDiv.style.gap = "8px";
      rightDiv.style.alignItems = "flex-end";

      const pill = document.createElement("span");
      const statusKey = (item.status || 'pending');
      pill.className = `status-pill ${statusKey}`;
      pill.textContent = translateStatus(statusKey);
      rightDiv.appendChild(pill);

      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.marginTop = "6px";

      const viewBtn = document.createElement("button");
      viewBtn.className = "btn ghost";
      viewBtn.textContent = currentLang === "en" ? "View Details" : "‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≥ã‡≤°‡≤ø";
      viewBtn.onclick = () => window.location.href = `consult_view.html?consult_id=${item.id || item.consultation_id}`;
      actions.appendChild(viewBtn);

      if (statusKey === "accepted") {
        const chatBtn = document.createElement("button");
        chatBtn.className = "btn";
        chatBtn.textContent = currentLang === "en" ? "Chat" : "‡≤ö‡≤æ‡≤ü‡≥ç";
        chatBtn.onclick = () => {
          window.location.href = `chat.html?consult_id=${item.id || item.consultation_id}&doctor_id=${item.doctor_id || item.doctorId || ''}`;
        };
        actions.appendChild(chatBtn);
      }

      if (statusKey === "pending") {
        const cancelBtn = document.createElement("button");
        cancelBtn.className = "btn ghost";
        cancelBtn.textContent = currentLang === "en" ? "Cancel" : "‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≤ø";
        cancelBtn.onclick = () => cancelConsult(item.id || item.consultation_id);
        actions.appendChild(cancelBtn);
      }

      rightDiv.appendChild(actions);
      card.innerHTML = leftHtml;
      card.appendChild(rightDiv);
      consultList.appendChild(card);
    });

  } catch (err) {
    consultSpinner.style.display = "none";
    consultEmpty.style.display = "";
    consultEmpty.textContent = currentLang === 'en' ? 'Failed to load consultations' : '‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    console.error("loadConsultStatus error:", err);
  }
}

async function cancelConsult(consultId) {
  if (!confirm(currentLang==='en' ? 'Cancel this consultation?' : '‡≤à ‡≤∏‡≤≤‡≤π‡≥Ü‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≥ã‡≤£‡≤µ‡≥á?')) return;
  try {
    const res = await apiFetch(`${BACKEND}/api/consultations/${consultId}/cancel`, { method: "PUT", headers: { "Content-Type": "application/json" } });
    alert(res.message || (currentLang==='en' ? 'Cancelled' : '‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤Ø‡≤ø‡≤§‡≥Å'));
    await loadConsultStatus();
  } catch (e) {
    console.error(e);
    alert(currentLang==='en' ? 'Action failed' : '‡≤ï‡≥ç‡≤∞‡≤ø‡≤Ø‡≥Ü ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* Translate status label to current language */
function translateStatus(status) {
  if (!status) return '';
  if (currentLang === 'kn') {
    if (status === 'pending') return '‡≤¨‡≤æ‡≤ï‡≤ø‡≤Ø‡≤ø‡≤¶‡≥Ü';
    if (status === 'accepted') return '‡≤∏‡≥ç‡≤µ‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    if (status === 'rejected') return '‡≤®‡≤ø‡≤∞‡≤æ‡≤ï‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    if (status === 'scheduled') return '‡≤®‡≤ø‡≤ó‡≤¶‡≤ø‡≤™‡≤°‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    return status;
  }
  return status.charAt(0).toUpperCase() + status.slice(1);
}

/* =============================
   Small helpers & startup
   ============================= */
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

/* Startup: load babies, doctors, consults and scans */
async function startup() {
  showSection('history'); // open baby history by default
  await loadBabies();
  await loadDoctors();
  await loadConsultStatus();
  await loadScans();

  const anyAccepted = (() => {
    try {
      const list = consultList.querySelectorAll('.baby-row');
      return Array.from(list).some(r => r.textContent.toLowerCase().includes('accepted') || r.innerHTML.includes('Chat'));
    } catch { return false; }
  })();
  if (anyAccepted) document.getElementById("chatFab").hidden = false;
}

/* load everything on start */
startup();
</script>

</body>
</html>