<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title data-en="Record Details" data-kn="‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≥Å">Record Details</title>

  <style>
    :root{
      --accent:#4CAF50;
      --primary:#1166ee;
      --bg:#f6fbff;
      --card:#fff;
      --muted:#6b7280;
      --shadow: 0 10px 30px rgba(15,23,42,0.06);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:#0f1724; }

    /* topbar */
    .topbar{ height:68px; display:flex; align-items:center; gap:16px; padding:0 20px; background:#fff; box-shadow:var(--shadow); position:sticky; top:0; z-index:90; }
    .brand{ display:flex; gap:12px; align-items:center; font-weight:700; }
    .logo{ width:46px; height:46px; border-radius:10px; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; }
    .top-actions{ margin-left:auto; display:flex; gap:12px; align-items:center; }

    .btn { padding:8px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:600; }
    .btn.primary{ background:var(--primary); color:#fff; }
    .btn.ghost{ background:#fff; border:1px solid #e6e9ef; }

    .container { max-width:1100px; margin:24px auto; padding:18px; display:grid; grid-template-columns: 1fr 360px; gap:18px; }

    /* main record box */
    .record { background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); }
    .record .image-box { width:100%; border-radius:10px; background:#f8fbff; display:flex; align-items:center; justify-content:center; overflow:hidden; }
    .record img { width:100%; height:auto; max-height:520px; object-fit:cover; display:block; }

    .meta { margin-top:12px; display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    .meta .pill { background:#f1f7ff; padding:8px 10px; border-radius:999px; font-weight:600; color:var(--primary); font-size:14px; }

    .details { margin-top:12px; line-height:1.5; }
    .label { font-weight:700; margin-right:6px; }

    /* right column */
    .side { display:flex; flex-direction:column; gap:12px; }
    .card { background:var(--card); border-radius:12px; padding:14px; box-shadow:var(--shadow); }
    .history-grid { display:flex; flex-direction:column; gap:10px; max-height:520px; overflow:auto; padding-right:6px; }

    .history-card { display:flex; gap:10px; align-items:center; padding:8px; border-radius:10px; background:#fbfdff; border:1px solid #eef6ff; cursor:pointer; }
    .history-thumb { width:80px; height:64px; border-radius:8px; overflow:hidden; background:#f0f4ff; display:flex; align-items:center; justify-content:center; }
    .history-thumb img { width:100%; height:100%; object-fit:cover; display:block; }

    .muted { color:var(--muted); font-size:13px; }

    /* modal */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,.6); display:flex; align-items:center; justify-content:center; z-index:300; }
    .modal .box { width:90%; max-width:900px; background:#fff; border-radius:12px; padding:14px; }
    .modal img { width:100%; height:auto; border-radius:8px; }

    /* responsive */
    @media (max-width:980px){
      .container{ grid-template-columns: 1fr; padding:12px; }
      .side{ order:-1; }
      .record img { max-height:320px; }
    }
  </style>
</head>
<body>

  <!-- topbar -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">üë∂</div>
      <div>
        <div style="font-size:14px" data-en="Smart Baby Skin Scanner" data-kn="‡≤∏‡≥ç‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ü‡≥ç ‡≤¨‡≥á‡≤¨‡≤ø ‡≤∏‡≥ç‡≤ï‡≤ø‡≤®‡≥ç ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≤∞‡≥ç">Smart Baby Skin Scanner</div>
        <div style="font-size:12px;color:var(--muted)" id="welcomeText">Record</div>
      </div>
    </div>

    <div class="top-actions">
      <select id="languageSwitcher" aria-label="Language">
        <option value="en">English</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
      </select>

      <button id="backBtn" class="btn ghost" title="Back">Back</button>
      <button id="chatBtn" class="btn primary" style="display:none">Chat</button>
    </div>
  </div>

  <!-- content -->
  <div class="container">

    <!-- main record -->
    <div class="record" id="recordCard">
      <div id="loadingMain" class="muted">Loading record‚Ä¶</div>

      <div id="recordContent" style="display:none">
        <div class="image-box">
          <img id="recordImage" src="" alt="Scan image">
        </div>

        <div class="meta">
          <div class="pill" id="rashType">Rash</div>
          <div class="pill" id="confidence">Confidence</div>
          <div class="muted" id="recordDate">Date</div>
        </div>

        <div class="details" id="recordDetails">
          <!-- filled by JS -->
        </div>
      </div>
    </div>

    <!-- right column: history + meta -->
    <aside class="side">
      <div class="card">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div>
            <div style="font-weight:700" data-en="Record Info" data-kn="‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø">Record Info</div>
            <div class="muted" id="subInfo">‚Äî</div>
          </div>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:700" data-en="Previous History" data-kn="‡≤π‡≤ø‡≤Ç‡≤¶‡≤ø‡≤® ‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏">Previous History</div>
        <div id="historyList" class="history-grid" style="margin-top:10px">
          <!-- history cards -->
        </div>
      </div>
    </aside>
  </div>

  <!-- modal for full image -->
  <div id="imageModal" class="modal" style="display:none">
    <div class="box">
      <button class="btn ghost" onclick="closeModal()">Close</button>
      <div style="height:12px"></div>
      <img id="modalImage" src="" alt="Full image">
    </div>
  </div>

<script>
/* ========== CONFIG & AUTH ========== */
const BACKEND = "http://127.0.0.1:5000";
const urlParams = new URLSearchParams(window.location.search);
const recordID = urlParams.get("record_id");

// token compatibility: prefer token, fallback to access_token
const token = localStorage.getItem("token") || localStorage.getItem("access_token");
const role = localStorage.getItem("role") || null;
const fullName = localStorage.getItem("full_name") || "";
let lang = localStorage.getItem("lang") || "en";

/* ========== UI refs ========== */
const backBtn = document.getElementById("backBtn");
const chatBtn = document.getElementById("chatBtn");
const loadingMain = document.getElementById("loadingMain");
const recordContent = document.getElementById("recordContent");
const recordImage = document.getElementById("recordImage");
const modal = document.getElementById("imageModal");
const modalImage = document.getElementById("modalImage");
const historyList = document.getElementById("historyList");
const recordDetails = document.getElementById("recordDetails");
const rashTypeEl = document.getElementById("rashType");
const confidenceEl = document.getElementById("confidence");
const recordDateEl = document.getElementById("recordDate");
const subInfo = document.getElementById("subInfo");
const languageSwitcher = document.getElementById("languageSwitcher");

/* redirect to login if no token */
if (!token) {
  window.location.href = "login.html";
}

/* set language selector */
languageSwitcher.value = lang;

/* ========== Multilanguage ========== */
function applyLanguage(l) {
  lang = l;
  localStorage.setItem("lang", l);
  document.querySelectorAll("[data-en]").forEach(el=>{
    el.textContent = el.getAttribute("data-" + l);
  });
  // welcome text
  document.getElementById("welcomeText").textContent = l === 'en' ? (fullName ? `Hello, ${fullName}` : 'Record') : `‡≤∏‡≥ç‡≤µ‡≤æ‡≤ó‡≤§ ${fullName ? fullName : ''}`;
}
languageSwitcher.addEventListener("change", (e)=> applyLanguage(e.target.value));
applyLanguage(lang);

/* ========== Helper: authenticated fetch ========= */
async function apiFetch(path, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers["Authorization"] = `Bearer ${token}`;
  try {
    const r = await fetch(path, opts);
    if (!r.ok) {
      const txt = await r.text();
      try { const j = JSON.parse(txt); throw new Error(j.message || txt); } catch { throw new Error(txt); }
    }
    return await r.json();
  } catch (err) {
    console.error("API error", err);
    throw err;
  }
}

/* ========== Back button behaviour ========= */
backBtn.addEventListener("click", () => {
  if (role === "parent") window.location.href = "parent_dashboard.html";
  else if (role === "doctor") window.location.href = "doctor_dashboard.html";
  else window.location.href = "home.html";
});

/* ========== Image modal ========= */
recordImage.addEventListener("click", () => {
  openModal(recordImage.src);
});
function openModal(src) {
  modalImage.src = src;
  modal.style.display = "flex";
}
function closeModal() {
  modal.style.display = "none";
  modalImage.src = "";
}

/* close modal on background click */
modal.addEventListener("click", (e)=> { if (e.target === modal) closeModal(); });

/* ========== Load record and history ========= */
async function loadRecordAndHistory() {
  if (!recordID) {
    loadingMain.textContent = lang === 'en' ? "No record selected." : "‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤Ü‡≤Ø‡≥ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤.";
    return;
  }

  loadingMain.style.display = "";
  recordContent.style.display = "none";
  try {
    // fetch record details (endpoint must return image_url, rash_type, confidence, created_at, baby_id, baby_name, doctor_name, consultation_id etc.)
    const record = await apiFetch(`${BACKEND}/api/records/${recordID}`); // adapt if your endpoint differs

    // main image + metadata
    const imageUrl = record.image_url || record.image_path || '';
    recordImage.src = imageUrl || 'placeholder.png';
    modalImage.src = imageUrl || 'placeholder.png';
    rashTypeEl.textContent = record.rash_type || (lang==='en'?'Unknown':'‡≤Ö‡≤ú‡≥ç‡≤û‡≤æ‡≤®');
    confidenceEl.textContent = (record.confidence ? `${record.confidence}%` : '');
    recordDateEl.textContent = record.created_at ? record.created_at : '';

    let infoHtml = `<div><span class="label" data-en="Baby" data-kn="‡≤Æ‡≤ó‡≥Å">Baby:</span> ${record.baby_name || ''}</div>`;
    if (record.doctor_name) infoHtml += `<div><span class="label" data-en="Doctor" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø">Doctor:</span> ${record.doctor_name}</div>`;
    if (record.notes) infoHtml += `<div style="margin-top:8px">${record.notes}</div>`;
    recordDetails.innerHTML = infoHtml;

    // sub info (small meta in side card)
    subInfo.textContent = `${record.baby_name || ''} ‚Ä¢ ${record.rash_type || ''}`;

    // show chat button only if consultation exists and status is accepted (backend should provide consult_status)
    if (record.consultation_id && record.consult_status === 'accepted') {
      chatBtn.style.display = '';
      chatBtn.onclick = () => {
        // navigate to chat with consult_id
        window.location.href = `chat.html?consult_id=${record.consultation_id}&record_id=${recordID}`;
      };
    } else {
      chatBtn.style.display = 'none';
    }

    // show main content
    loadingMain.style.display = "none";
    recordContent.style.display = "";

    // now load baby history (by baby_id)
    const babyId = record.baby_id || record.babyId;
    if (babyId) loadBabyHistory(babyId);
    else {
      historyList.innerHTML = `<div class="muted">${lang==='en' ? 'No baby history available' : '‡≤∂‡≤ø‡≤∂‡≥Å ‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏ ‡≤≤‡≤≠‡≥ç‡≤Ø‡≤µ‡≤ø‡≤≤‡≥ç‡≤≤'}</div>`;
    }

  } catch (err) {
    loadingMain.textContent = lang === 'en' ? `Failed to load record: ${err.message || err}` : `‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü: ${err.message || err}`;
    recordContent.style.display = "none";
  }
}

/* ========== Load baby history thumbnails ========= */
async function loadBabyHistory(babyId) {
  historyList.innerHTML = `<div class="muted">${lang==='en' ? 'Loading history...' : '‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...'}</div>`;
  try {
    const res = await apiFetch(`${BACKEND}/api/history/${babyId}`);
    // res expected to be { history: [ { id, image_url, rash_type, created_at, confidence } ] } OR an array
    const history = Array.isArray(res) ? res : (res.history || []);
    if (!history.length) {
      historyList.innerHTML = `<div class="muted">${lang === 'en' ? 'No prior scans' : '‡≤π‡≤ø‡≤Ç‡≤¶‡≤ø‡≤® ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≥ç‡≤∏‡≥ç ‡≤á‡≤≤‡≥ç‡≤≤'}</div>`;
      return;
    }

    historyList.innerHTML = '';
    history.forEach(h => {
      const card = document.createElement('div');
      card.className = 'history-card';
      card.innerHTML = `
        <div class="history-thumb"><img src="${h.image_url || h.image_path || 'placeholder.png'}" alt=""></div>
        <div style="flex:1">
          <div style="font-weight:700">${h.rash_type || ''}</div>
          <div class="muted">${h.created_at || ''}</div>
        </div>
      `;
      card.addEventListener('click', ()=> {
        // open this scan in modal or as record view
        if (role === 'doctor') {
          // doctors might want to open record view page for the scan id if exists
          if (h.id) window.location.href = `doctor_record_view.html?record_id=${h.id}`;
          else openModal(h.image_url || h.image_path || '');
        } else {
          // parents open scan_view page or modal
          if (h.id) window.location.href = `scan_view.html?scan_id=${h.id}`;
          else openModal(h.image_url || h.image_path || '');
        }
      });
      historyList.appendChild(card);
    });
  } catch (err) {
    historyList.innerHTML = `<div class="muted">${lang === 'en' ? 'Failed to load history' : '‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏ ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
    console.error(err);
  }
}

/* kickoff */
loadRecordAndHistory();
</script>

</body>
</html>
