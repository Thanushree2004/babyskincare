<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Doctor Dashboard</title>

  <style>
    body {
      background: #eaf7ff;
      margin: 0;
      font-family: Arial;
    }

    nav {
      background: #4CAF50;
      color: white;
      padding: 10px 20px;
      display: flex;
      justify-content: space-between;
    }

    .container {
      max-width: 900px;
      margin: 40px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
    }

    h1 {
      text-align: center;
      color: #333;
    }

    .consult-card {
      background: #f9f9f9;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .consult-details {
      width: 70%;
    }

    .consult-actions button {
      padding: 8px 15px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-left: 10px;
      color: white;
      font-size: 14px;
    }

    .accept-btn {
      background: #4CAF50;
    }

    .reject-btn {
      background: #E74C3C;
    }

    .accept-btn:hover {
      background: #45a049;
    }

    .reject-btn:hover {
      background: #c0392b;
    }

    .details-box {
      margin-top: 20px;
      background: #f0faff;
      padding: 15px;
      border-radius: 10px;
    }

    .details-box img {
      width: 100%;
      max-height: 250px;
      object-fit: cover;
      border-radius: 10px;
    }
  </style>
</head>

<body>

  <!-- NAVBAR -->
  <nav>
    <div class="logo" data-en="Doctor Dashboard" data-kn="ಡಾಕ್ಟರ್ ಡ್ಯಾಶ್‌ಬೋರ್ಡ್">
      Doctor Dashboard
    </div>

    <select id="languageSwitcher">
      <option value="en">English</option>
      <option value="kn">ಕನ್ನಡ</option>
    </select>
  </nav>

  <div class="container">
    <h1 data-en="Consultation Requests" data-kn="ಸಲಹೆ ವಿನಂತಿಗಳು">
      Consultation Requests
    </h1>

    <div id="requestsBox">
      Loading...
    </div>

    <!-- Detailed View -->
    <div id="detailsBox" class="details-box" style="display:none;"></div>
  </div>

  <script>
    const BACKEND = "http://127.0.0.1:5000";

    // ------------------------------------------------
    // LANGUAGE
    // ------------------------------------------------
    const switcher = document.getElementById("languageSwitcher");
    const savedLang = localStorage.getItem("lang") || "en";
    switcher.value = savedLang;
    applyLang(savedLang);
    switcher.addEventListener("change", () => applyLang(switcher.value));

    function applyLang(lang) {
      document.querySelectorAll("[data-en]").forEach(el => {
        el.textContent = el.getAttribute(`data-${lang}`);
      });
      localStorage.setItem("lang", lang);
    }

    // ------------------------------------------------
    // LOAD CONSULTATION REQUESTS
    // ------------------------------------------------
    async function loadRequests() {
      const token = localStorage.getItem("access_token");
      const box = document.getElementById("requestsBox");
      box.innerHTML = "Loading...";

      const res = await fetch(`${BACKEND}/api/consultations/doctor`, {
        headers: { "Authorization": `Bearer ${token}` }
      });

      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        box.innerHTML = "<p>No requests yet.</p>";
        return;
      }

      box.innerHTML = "";
      data.forEach(req => {
        box.innerHTML += `
          <div class="consult-card">
            <div class="consult-details">
              <p><strong>Baby:</strong> ${req.baby_name}</p>
              <p><strong>Rash:</strong> ${req.rash_type}</p>
              <p><strong>Status:</strong> ${req.status}</p>
              <p><strong>Requested:</strong> ${req.requested_at}</p>
            </div>

            <div class="consult-actions">
              <button class="accept-btn" onclick="updateStatus(${req.consultation_id}, 'accepted')"
                data-en="Accept" data-kn="ಸ್ವೀಕರಿಸಿ">Accept</button>

              <button class="reject-btn" onclick="updateStatus(${req.consultation_id}, 'rejected')"
                data-en="Reject" data-kn="ನಿರಾಕರಿಸಿ">Reject</button>

              <button class="accept-btn" onclick="loadDetails(${req.consultation_id}, '${req.record_id}')">
                View Details
              </button>
            </div>
          </div>
        `;
      });
    }

    loadRequests();

    // ------------------------------------------------
    // UPDATE CONSULTATION STATUS
    // ------------------------------------------------
    async function updateStatus(id, status) {
      const token = localStorage.getItem("access_token");

      const res = await fetch(`${BACKEND}/api/consultations/${id}/update`, {
        method: "PUT",
        headers: {
          "Authorization": `Bearer ${token}`,
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ status })
      });

      const data = await res.json();
      alert(data.message);
      loadRequests();
    }

    // ------------------------------------------------
    // LOAD BABY RECORD DETAILS
    // ------------------------------------------------
    async function loadDetails(consultID, recordID) {
      const token = localStorage.getItem("access_token");

      const res = await fetch(`${BACKEND}/api/consultations/details/${recordID}`, {
        method: "GET",
        headers: { "Authorization": `Bearer ${token}` }
      });

      const data = await res.json();

      const box = document.getElementById("detailsBox");
      box.style.display = "block";

      if (data.error) {
        box.innerHTML = `<p>${data.error}</p>`;
        return;
      }

      box.innerHTML = `
        <h3>Record Details</h3>
        <img src="${data.image_path}">
        <p><strong>Baby:</strong> ${data.baby_name}</p>
        <p><strong>Rash:</strong> ${data.rash}</p>
        <p><strong>Confidence:</strong> ${data.confidence}</p>
        <p><strong>Date:</strong> ${data.created_at}</p>
      `;
    }
  </script>
</body>
<script src="script.js"></script>

</html>
