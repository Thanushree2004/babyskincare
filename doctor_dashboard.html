<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title data-en="Doctor Dashboard" data-kn="‡≤™‡≥ã‡≤∑‡≤ï‡≤∞ ‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç">Parent Dashboard</title>

  <style>
    :root{
      --primary:#1166ee;
      --accent:#4CAF50;
      --bg:#f6fbff;
      --card:#fff;
      --muted:#6b7280;
      --shadow: 0 8px 24px rgba(15,23,42,0.06);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:#111827; }

    /* Topbar */
    .topbar{ height:68px; display:flex; align-items:center; gap:16px; padding:0 20px; background:#fff; box-shadow:var(--shadow); position:sticky; top:0; z-index:90; }
    .brand{ display:flex; gap:12px; align-items:center; font-weight:700;}
    .logo{ width:46px; height:46px; border-radius:10px; background:var(--accent); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow:0 3px 8px rgba(0,0,0,0.08); }
    .top-actions{ margin-left:auto; display:flex; gap:12px; align-items:center;}

    .btn{ background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.ghost{ background:#fff; color:#111; border:1px solid #e6e9ef; box-shadow:none; }
    .btn.secondary{ background:#10b981; }

    /* Layout */
    .layout{ display:flex; gap:24px; padding:26px; max-width:1200px; margin:20px auto; align-items:flex-start; }

    /* Sidebar */
    .sidebar{ width:260px; background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); position:sticky; top:88px; height:calc(100vh - 120px); display:flex; flex-direction:column; gap:12px; }
    .sidebar .menu-title{ font-weight:700; color:#0f1724; margin-bottom:6px; }
    .nav-item{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; color:#374151; cursor:pointer; text-decoration:none; }
    .nav-item:hover{ background:#f3f6ff; color:var(--primary); }
    .nav-item.active{ background:#eaf2ff; color:var(--primary); font-weight:700; }
    .small-muted{ font-size:13px; color:var(--muted); }

    /* Main */
    .main{ flex:1; display:flex; flex-direction:column; gap:18px; min-height:60vh; }
    .card{ background:var(--card); padding:18px; border-radius:12px; box-shadow:var(--shadow); }
    .card.row{ display:flex; gap:18px; flex-wrap:wrap; }
    .card.small{ flex:0 0 220px; display:flex; flex-direction:column; gap:8px; justify-content:center; }
    .muted{ color:var(--muted); font-size:13px; }

    /* baby list / history */
    .baby-list{ display:flex; flex-direction:column; gap:10px; margin-top:8px; }
    .baby-row{ display:flex; justify-content:space-between; align-items:center; padding:12px; border-radius:10px; background:#fbfdff; border:1px solid #f1f5f9; }
    .baby-row .meta{ font-size:13px; color:var(--muted); }

    /* doctors list */
    .doctor-card{ display:flex; gap:12px; align-items:center; padding:12px; border-radius:10px; border:1px solid #eef3ff; background:#fff; }
    .doctor-photo{ width:56px; height:56px; border-radius:8px; background:#f1f5f9; display:flex; align-items:center; justify-content:center; font-weight:700; color:#334155; }

    /* status pill (used in consult list) */
    .status-pill { padding:6px 10px; border-radius:999px; font-weight:700; color:#fff; display:inline-block; }
    .status-pill.pending { background:#f39c12; }
    .status-pill.accepted { background:#10b981; }
    .status-pill.rejected { background:#ef4444; }

    /* responsive */
    @media (max-width:960px){
      .layout{ padding:12px; margin:12px; flex-direction:column; max-width:960px; }
      .sidebar{ width:100%; height:auto; position:relative; top:0; flex-direction:row; align-items:center; overflow:auto; padding:12px; gap:8px; }
      .sidebar .menu-title{ display:none; }
      .card.small{ flex:1 1 48%; }
    }

    /* Chat floating button */
    .chat-fab{ position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%; background:var(--primary); color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 20px rgba(17,102,238,0.18); cursor:pointer; z-index:200; }
    .chat-fab[hidden]{ display:none; }
  </style>
</head>
<body>

  <!-- TOPBAR -->
  <div class="topbar">
    <div class="brand">
      <div class="logo">üë∂</div>
      <div>
        <div style="font-size:14px" data-en="Smart Baby Skin Scanner" data-kn="‡≤∏‡≥ç‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ü‡≥ç ‡≤¨‡≥á‡≤¨‡≤ø ‡≤∏‡≥ç‡≤ï‡≤ø‡≤®‡≥ç ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≤∞‡≥ç">Smart Baby Skin Scanner</div>
        <div style="font-size:12px;color:var(--muted)" id="welcomeText">Welcome</div>
      </div>
    </div>

    <div class="top-actions">
      <select id="languageSwitcher">
        <option value="en">English</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
      </select>

      <button class="btn ghost" onclick="openDashboard()" data-en="Dashboard" data-kn="‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç">Dashboard</button>
      <button class="btn" onclick="logout()" data-en="Logout" data-kn="‡≤≤‡≤æ‡≤ó‡≥å‡≤ü‡≥ç">Logout</button>
    </div>
  </div>

  <!-- LAYOUT -->
  <div class="layout">

    <!-- SIDEBAR -->
    <aside class="sidebar" role="navigation" aria-label="Doctor menu">
      <div class="menu-title" data-en="Doctor Menu" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞ ‡≤Æ‡≥Ü‡≤®‡≥Å">Doctor Menu</div>

      <div class="nav-item" id="nav_appointments" onclick="showSection('consult_status')">
        <span>üìÖ</span><span data-en="View Appointments" data-kn="‡≤®‡≤ø‡≤ó‡≤¶‡≤ø‡≤§ ŸÖŸÑÿßŸÇÿßÿ™‡≤ó‡≤≥‡≥Å" style="flex:1">View Appointments</span>
      </div>

      <div class="nav-item" id="nav_history" onclick="showSection('history')">
        <span>üìú</span><span data-en="Patient History" data-kn="‡≤∞‡≥ã‡≤ó‡≤ø‡≤Ø ‡≤á‡≤§‡≤ø‡≤π‡≤æ‡≤∏" style="flex:1">Patient History</span>
      </div>

      <div class="nav-item" id="nav_profile" onclick="showSection('docprofile')">
        <span>üë§</span><span data-en="My Profile" data-kn="‡≤®‡≤®‡≥ç‡≤® ‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç" style="flex:1">My Profile</span>
      </div>

      <div class="nav-item" id="nav_chat" onclick="showSection('chat')">
        <span>üí¨</span><span data-en="Chat" data-kn="‡≤ö‡≤æ‡≤ü‡≥ç" style="flex:1">Chat</span>
      </div>

      <div style="margin-top:auto; font-size:13px; color:var(--muted);">
        <div data-en="Logged in as" data-kn="‡≤≤‡≤æ‡≤ó‡≤ø‡≤®‡≥ç ‡≤Ü‡≤ó‡≤ø‡≤∞‡≥Å‡≤µ ‡≤™‡≤æ‡≤§‡≥ç‡≤∞">Logged in as</div>
        <strong id="userName">Parent</strong>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main">

      <!-- DEFAULT: Patients (doctor view) -->
      <section id="section_history" class="card large">
        <h1 data-en="Patients" data-kn="‡≤∞‡≥ã‡≤ó‡≤ø‡≤ó‡≤≥‡≥Å">Patients</h1>
        <p class="muted" data-en="List of patients and recent consultation requests" data-kn="‡≤∞‡≥ã‡≤ó‡≤ø‡≤ó‡≤≥ ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤á‡≤§‡≥ç‡≤§‡≥Ä‡≤ö‡≤ø‡≤® ‡≤∏‡≤≤‡≤π‡≥Ü ‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø‡≤ó‡≤≥‡≥Å">List of patients and recent consultation requests</p>

        <div style="margin-top:14px">
          <div class="card row" style="align-items:flex-start; padding:12px;">
            <div style="flex:1;">
              <h3 data-en="Patient List" data-kn="‡≤∞‡≥ã‡≤ó‡≤ø‡≤ó‡≤≥ ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø">Patient List</h3>
              <div id="patientList" class="baby-list"></div>
            </div>

            <div style="width:480px;">
              <h3 data-en="Selected Patient" data-kn="‡≤Ü‡≤Ø‡≥ç‡≤¶ ‡≤∞‡≥ã‡≤ó‡≤ø">Selected Patient</h3>
              <div id="selectedPatientCard" style="margin-top:8px"></div>
            </div>
          </div>
        </div>
      </section>

      <!-- DOCTORS LIST -->
      <section id="section_doctors" class="card large" style="display:none;">
        <h1 data-en="Doctors" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≥Å">Doctors</h1>
        <p class="muted" data-en="Choose a doctor for consultation" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤æ‡≤ó‡≤ø ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">Choose a doctor for consultation</p>

        <div id="doctorsList" style="margin-top:12px; display:flex; flex-direction:column; gap:12px;"></div>
      </section>

      <!-- DOCTOR PROFILE / BOOKING -->
      <section id="section_docprofile" class="card large" style="display:none;">
        <h1 id="docTitle">Doctor Profile</h1>
        <div id="docProfileArea" style="margin-top:12px;"></div>
      </section>

      <!-- CONSULTATION STATUS (NEW MODERN SYSTEM) -->
      <section id="section_consult_status" class="card large" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          
          <div>
            <h1 data-en="Consultation Status" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø">Consultation Status</h1>
            <p class="muted"
               data-en="Track your booked consultations and their current status"
               data-kn="‡≤®‡≥Ä‡≤µ‡≥Å ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø‡≤¶ ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥ ‡≤∏‡≥ç‡≤•‡≤ø‡≤§‡≤ø‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤ü‡≥ç‡≤∞‡≥ç‡≤Ø‡≤æ‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">
               Track your booked consultations and their current status
            </p>
          </div>

          <div style="display:flex;gap:10px;align-items:center;">
            <button id="consultRefreshBtn" class="btn ghost"
              data-en="Refresh" data-kn="‡≤Ö‡≤™‡≥ç‚Äå‡≤°‡≥á‡≤ü‡≥ç">Refresh</button>

            <button id="consultCreateBtn" class="btn"
              data-en="Book New" data-kn="‡≤π‡≥ä‡≤∏‡≤¶‡≥Å ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">Book New</button>
          </div>

        </div>

        <div id="consultStatusArea" style="margin-top:16px;">
          
          <!-- Spinner -->
          <div id="consultSpinner" style="display:none;padding:16px;text-align:center;color:var(--muted);">
            <span data-en="Loading consultations‚Ä¶" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü‚Ä¶">
              Loading consultations‚Ä¶
            </span>
          </div>

          <!-- Empty message -->
          <div id="consultEmpty" style="display:none;padding:16px;text-align:center;color:var(--muted);">
            <span data-en="No consultations found." data-kn="‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤.">
              No consultations found.
            </span>
          </div>

          <!-- List container -->
          <div id="consultList" style="display:none;display:flex;flex-direction:column;gap:12px;"></div>

        </div>
      </section>

      <!-- PROFILE -->
      <section id="section_profile" class="card large" style="display:none;">
        <h1 data-en="My Profile" data-kn="‡≤®‡≤®‡≥ç‡≤® ‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç">My Profile</h1>
        <div id="profileArea" style="margin-top:12px"></div>
      </section>

      <!-- CHAT -->
      <section id="section_chat" class="card large" style="display:none;">
        <div style="display:flex;justify-content:space-between;align-items:center;">
          <div>
            <h1 id="chatTitle">Chat</h1>
            <p class="muted" id="chatSubtitle">Connect with patients about consultations</p>
          </div>
        </div>

        <div style="margin-top:12px; display:flex; gap:16px;">
          <div style="flex:1; display:flex; flex-direction:column; gap:8px;">
            <div id="chatMessages" style="flex:1; overflow:auto; max-height:480px; padding:12px; border-radius:8px; background:#fbfdff; border:1px solid #eef3ff"></div>

            <div style="display:flex; gap:8px; align-items:center;">
              <input id="chatInput" type="text" placeholder="Type a message" style="flex:1; padding:10px; border-radius:8px; border:1px solid #e6e9ef" />
              <button id="chatSendBtn" class="btn">Send</button>
            </div>
          </div>

          <div style="width:320px;">
            <h3 data-en="Conversation Info" data-kn="‡≤∏‡≤Ç‡≤≠‡≤æ‡≤∑‡≤£‡≥Ü‡≤Ø ‡≤Æ‡≤æ‡≤π‡≤ø‡≤§‡≤ø">Conversation Info</h3>
            <div id="chatInfo" style="margin-top:8px; padding:12px; border-radius:8px; background:#fff; border:1px solid #eef3ff"></div>
          </div>
        </div>
      </section>

    </main>

  </div>

  <!-- Chat Floating Button (visible only when chat allowed) -->
  <div id="chatFab" class="chat-fab" title="Open Chat" onclick="openChat()" hidden>üí¨</div>

<script>
/* ============================
   Config & Auth
   ============================ */
const BACKEND = "http://127.0.0.1:5000"; // change if needed
const token = localStorage.getItem("token") || localStorage.getItem("access_token");
const role = localStorage.getItem("role");
const userId = localStorage.getItem("user_id");
const fullName = localStorage.getItem("full_name") || "Parent";
let currentLang = localStorage.getItem("lang") || "en";

/* PAGE PROTECTION (doctor only) */
if (!token) {
  window.location.href = "login.html";
}
if (role !== "doctor") {
  // Only doctors should access this page; redirect others to login
  window.location.href = "login.html";
}

/* UI init */
document.getElementById("userName").textContent = fullName;
document.getElementById("welcomeText").textContent = currentLang === "en" ? `Welcome, ${fullName}` : `‡≤∏‡≥ç‡≤µ‡≤æ‡≤ó‡≤§, ${fullName}`;
document.getElementById("languageSwitcher").value = currentLang;

/* MULTI-LANGUAGE ENGINE */
function setLanguage(lang) {
  currentLang = lang;
  localStorage.setItem("lang", lang);
  document.querySelectorAll("[data-en]").forEach(el => {
    el.textContent = el.getAttribute("data-" + lang);
  });
  document.querySelectorAll("[data-en-placeholder]").forEach(el => {
    el.placeholder = el.getAttribute(`data-${lang}-placeholder`);
  });
  // update welcome text
  document.getElementById("welcomeText").textContent = lang === "en" ? `Welcome, ${fullName}` : `‡≤∏‡≥ç‡≤µ‡≤æ‡≤ó‡≤§, ${fullName}`;
}
document.getElementById("languageSwitcher").addEventListener("change", e => setLanguage(e.target.value));
setLanguage(currentLang);

/* SECTION NAV */
function hideAllSections() {
  ["history","doctors","docprofile","consult_status","profile","chat"].forEach(s => {
    const el = document.getElementById("section_" + s);
    if (el) el.style.display = "none";
    const nav = document.getElementById("nav_" + s);
    if (nav) nav.classList.remove("active");
  });
}
function showSection(section) {
  hideAllSections();
    // Normalize section -> actual section id mapping
    let targetId = "section_" + section;
    // some sections are named differently in DOM
    if (section === 'consult_status') targetId = 'section_consult_status';
    if (section === 'docprofile') targetId = 'section_docprofile';
    const sectionEl = document.getElementById(targetId);
    if (sectionEl) sectionEl.style.display = "";

    // Map section to sidebar nav id for highlighting
    let navId = 'nav_appointments';
    if (section === 'history') navId = 'nav_history';
    else if (section === 'docprofile' || section === 'profile') navId = 'nav_profile';
    else if (section === 'consult_status') navId = 'nav_appointments';

    const navEl = document.getElementById(navId);
    if (navEl) navEl.classList.add("active");

    // Load content hooks
    if (section === 'history') loadPatients();
    if (section === 'consult_status') loadConsultStatus();
    if (section === 'docprofile' || section === 'profile') loadProfileForm();
    if (section === 'chat') {
      // keep chat ready; if a consult is selected this will be loaded by openChatForConsult
      // otherwise clear view
      if (!currentChatConsultId) {
        document.getElementById('chatMessages').innerHTML = `<div class="muted">${currentLang==='en'?'Select a consultation to start chat':'‡≤ö‡≤æ‡≤ü‡≥ç ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≤≤‡≥Å ‡≤í‡≤Ç‡≤¶‡≥Å ‡≤∏‡≤≤‡≤π‡≥Ü ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø'}</div>`;
        document.getElementById('chatInfo').innerHTML = '';
      }
    }
}

/* OPEN DASHBOARD (keeps compatibility) */
function openDashboard() { showSection('history'); }

/* LOGOUT */
function logout() {
  localStorage.removeItem("token");
  localStorage.removeItem("role");
  localStorage.removeItem("user_id");
  localStorage.removeItem("full_name");
  window.location.href = "login.html";
}

/* Chat control (visible only when allowed) */
function openChat() {
  // This should navigate to your chat UI; placeholder:
  window.location.href = `chat.html?user_id=${userId}`;
}

/* ============================
   Backend calls & UI rendering
   ============================ */

/* Helper: fetch JSON with auth */
async function apiFetch(url, options = {}) {
  options.headers = options.headers || {};
  options.headers["Authorization"] = `Bearer ${token}`;
  try {
    const res = await fetch(url, options);
    if (!res.ok) {
      // try to read json error
      const txt = await res.text();
      try { const j = JSON.parse(txt); throw new Error(j.message || txt); } catch { throw new Error(txt); }
    }
    return await res.json();
  } catch (err) {
    console.error("API error", err);
    throw err;
  }
}

/* Patients list for doctor */
let patientsRequests = [];
let selectedPatientKey = null;
// keep a safe empty babies array for legacy booking UI (avoids undefined errors)
let babies = [];
async function loadPatients(){
  const listEl = document.getElementById('patientList');
  listEl.innerHTML = `<div class="muted">${currentLang==='en'?'Loading...':'‡≤≤‡≥ã‡≤°‡≥Ü‡≥ñ‡≤Ç‡≤ó‡≥ç...'}</div>`;
  try {
    const data = await apiFetch(`${BACKEND}/api/consultations/doctor`);
    patientsRequests = Array.isArray(data) ? data : [];
    // group by baby_name (patient)
    const map = new Map();
    patientsRequests.forEach(r => {
      const key = r.baby_name || `Patient-${r.record_id || Math.random()}`;
      if (!map.has(key)) map.set(key, []);
      map.get(key).push(r);
    });
    // render
    listEl.innerHTML = '';
    if (map.size === 0){
      listEl.innerHTML = `<div class="muted">${currentLang==='en'?'No patients found':'‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∞‡≥ã‡≤ó‡≤ø‡≤ó‡≤≥‡≥Å ‡≤á‡≤≤‡≥ç‡≤≤'}</div>`;
      return;
    }
    [...map.entries()].forEach(([name, arr]) => {
      const div = document.createElement('div');
      div.className = 'baby-row';
      const last = arr.reduce((a,b)=> (a.requested_at > b.requested_at? a: b));
      div.innerHTML = `
        <div>
          <strong>${escapeHtml(name)}</strong>
          <div class="meta">${escapeHtml(last.requested_at || '')} ‚Ä¢ ${escapeHtml(last.rash_type || '')}</div>
        </div>
        <div style="display:flex;gap:8px;align-items:center;">
          <button class="btn ghost">Details</button>
          <button class="btn" onclick="selectPatient('${name.replace(/'/g, "\\'")}')">Open</button>
        </div>
      `;
      listEl.appendChild(div);
    });
  } catch(e){
    console.error(e);
    listEl.innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load patients':'‡≤∞‡≥ã‡≤ó‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

function selectPatient(name){
  selectedPatientKey = name;
  const arr = patientsRequests.filter(r => r.baby_name === name);
  renderSelectedPatient(name, arr);
}

function renderSelectedPatient(name, arr){
  const area = document.getElementById('selectedPatientCard');
  if (!arr || !arr.length) {
    area.innerHTML = `<div class="muted">${currentLang==='en'?'No records for this patient':'‡≤à ‡≤∞‡≥ã‡≤ó‡≤ø‡≤ó‡≥Ü ‡≤¶‡≤æ‡≤ñ‡≤≤‡≥Ü‡≤ó‡≤≥‡≤ø‡≤≤‡≥ç‡≤≤'}</div>`;
    return;
  }
  let html = `<div style="display:flex;flex-direction:column;gap:8px;">`;
  html += `<div style="padding:12px;border-radius:10px;background:#fbfdff;border:1px solid #eef3ff"><strong>${escapeHtml(name)}</strong></div>`;
  html += `<div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">`;
  arr.forEach(s => {
    html += `
      <div class="baby-row">
        <div>
          <strong>${escapeHtml(s.rash_type || '')}</strong>
          <div class="meta">${escapeHtml(s.requested_at || '')}</div>
        </div>
        <div>
          <button class="btn ghost" onclick="viewRecord(${s.record_id})">${currentLang==='en'?'View Record':'‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤ø‡≤∏‡≤ø'}</button>
          <button class="btn" onclick="openChatForConsult(${s.consultation_id || s.id}, ${s.doctor_id || ''})">${currentLang==='en'?'Chat':'‡≤ö‡≤æ‡≤ü‡≥ç'}</button>
        </div>
      </div>`;
  });
  html += `</div></div>`;
  area.innerHTML = html;
}

/* view single scan (open new page or modal) */
function viewScan(scanId) {
  window.location.href = `scan_view.html?scan_id=${scanId}`;
}

/* manual open baby history */
function openBabyHistory(babyId) {
  // Legacy stub: show Patients section. Detailed baby-history rendering
  // was removed when converting to doctor view.
  showSection('history');
  // Ensure patients are loaded so the doctor can find the record
  try { loadPatients(); } catch(e) { /* ignore */ }
}

/* ----------------------------
   DOCTORS LIST & PROFILE
   ---------------------------- */
let doctors = [];
async function loadDoctors() {
  try {
    const data = await apiFetch(`${BACKEND}/api/doctors`);
    doctors = Array.isArray(data) ? data : [];
    renderDoctorsList();
  } catch (e) {
    console.error(e);
    document.getElementById("doctorsList").innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load doctors':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

function renderDoctorsList() {
  const area = document.getElementById("doctorsList");
  area.innerHTML = "";
  if (!doctors.length) {
    area.innerHTML = `<div class="muted">${currentLang==='en'?'No doctors found':'‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≥Å ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤'}</div>`;
    return;
  }

  doctors.forEach(d => {
    const div = document.createElement("div");
    div.className = "doctor-card";
    div.innerHTML = `
      <div style="display:flex;gap:12px;align-items:center;flex:1">
        <div class="doctor-photo">${escapeHtml((d.first_name || 'D').charAt(0))}</div>
        <div style="flex:1">
          <div style="font-weight:700">${escapeHtml(d.first_name)} ${escapeHtml(d.last_name || '')}</div>
          <div class="muted">${escapeHtml(d.specialization || '')} ‚Ä¢ ${escapeHtml(String(d.experience || 'N/A'))} yrs</div>
        </div>
      </div>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button class="btn ghost" onclick="viewDoctor(${d.id})">${currentLang==='en'?'View Profile':'‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç ‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤ø‡≤∏‡≤ø'}</button>
        <button class="btn" onclick="bookWithDoctor(${d.id})">${currentLang==='en'?'Book':'‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø'}</button>
      </div>
    `;
    area.appendChild(div);
  });
}

async function viewDoctor(id) {
  try {
    const doc = await apiFetch(`${BACKEND}/api/doctors/${id}`);
    showDoctorProfile(doc);
  } catch (e) {
    console.error(e);
    alert(currentLang==='en'?'Failed to load doctor':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* Show doctor profile in profile section with booking options */
function showDoctorProfile(doc) {
  showSection('docprofile');
  document.getElementById("docTitle").textContent = (currentLang==='en' ? 'Doctor Profile' : '‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞ ‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç') + ` ‚Äî ${doc.first_name} ${doc.last_name || ''}`;
  const area = document.getElementById("docProfileArea");
  area.innerHTML = `
    <div style="display:flex;gap:18px;align-items:flex-start;">
      <div style="width:140px;height:140px;border-radius:12px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-weight:700">${escapeHtml((doc.first_name||'D').charAt(0))}</div>
      <div style="flex:1">
        <h3 style="margin:0">${escapeHtml(doc.first_name)} ${escapeHtml(doc.last_name || '')}</h3>
        <div class="muted">${escapeHtml(doc.specialization || '')} ‚Ä¢ ${escapeHtml(String(doc.experience || ''))} yrs</div>
        <p style="margin-top:10px">${escapeHtml(doc.bio || '')}</p>
        <div style="display:flex;gap:8px;margin-top:12px">
          <button class="btn" onclick="openBookingForm(${doc.id})" data-en="Book Consultation" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Book Consultation':'‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø'}</button>
          <button class="btn ghost" onclick="showSection('doctors')" data-en="Back to Doctors" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤ø‡≤ó‡≥Ü ‡≤π‡≤ø‡≤Ç‡≤§‡≤ø‡≤∞‡≥Å‡≤ó‡≤ø">${currentLang==='en'?'Back to Doctors':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞‡≤ø‡≤ó‡≥Ü ‡≤π‡≤ø‡≤Ç‡≤§‡≤ø‡≤∞‡≥Å‡≤ó‡≤ø'}</button>
        </div>
      </div>
    </div>

    <div id="bookingFormContainer" style="margin-top:18px"></div>
  `;
}

/* Load editable doctor profile (called when doctor opens profile section) */
async function loadProfileForm() {
  const area = document.getElementById('docProfileArea');
  area.innerHTML = `<div class="muted">${currentLang==='en'?'Loading profile...':'‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç ‡≤Ö‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...'}</div>`;
  try {
    const docResp = await apiFetch(`${BACKEND}/api/doctor/profile`);
    // backend may return a wrapper { user: {...} } or direct object
    const doc = docResp && docResp.user ? docResp.user : docResp || {};
    // if profile is empty object, fall back to empty form so doctor can enter details
    const first = escapeHtml(doc.first_name || '');
    const last = escapeHtml(doc.last_name || '');
    const spec = escapeHtml(doc.specialization || '');
    const exp = escapeHtml(String(doc.experience || ''));
    const bio = escapeHtml(doc.bio || '');
    area.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <label data-en="First name" data-kn="‡≤Æ‡≥ä‡≤¶‡≤≤ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å">${currentLang==='en'?'First name':'‡≤Æ‡≥ä‡≤¶‡≤≤ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å'}</label>
        <input id="doc_first_name" type="text" value="${first}" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Last name" data-kn="‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å">${currentLang==='en'?'Last name':'‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å'}</label>
        <input id="doc_last_name" type="text" value="${last}" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Specialization" data-kn="‡≤§‡≤ú‡≥ç‡≤û‡≤§‡≥Ü">${currentLang==='en'?'Specialization':'‡≤§‡≤ú‡≥ç‡≤û‡≤§‡≥Ü'}</label>
        <input id="doc_specialization" type="text" value="${spec}" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Experience (years)" data_kn="‡≤Ö‡≤®‡≥Å‡≤≠‡≤µ (‡≤µ‡≤∞‡≥ç‡≤∑‡≤ó‡≤≥‡≥Å)" data-kn="‡≤Ö‡≤®‡≥Å‡≤≠‡≤µ (‡≤µ‡≤∞‡≥ç‡≤∑‡≤ó‡≤≥‡≥Å)">${currentLang==='en'?'Experience (years)':'‡≤Ö‡≤®‡≥Å‡≤≠‡≤µ (‡≤µ‡≤∞‡≥ç‡≤∑‡≤ó‡≤≥‡≥Å)'}</label>
        <input id="doc_experience" type="number" value="${exp}" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Bio" data_kn="‡≤ú‡≥Ä‡≤µ‡≤∞‡µá‡¥ñ‡≥Ü" data-kn="‡≤ú‡≥Ä‡≤µ‡≤∞‡≥á‡≤ñ‡≥Ü">${currentLang==='en'?'Bio':'‡≤ú‡≥Ä‡≤µ‡≤∞‡≥á‡≤ñ‡≥Ü'}</label>
        <textarea id="doc_bio" rows="4" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef">${bio}</textarea>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="saveDoctorProfile()">${currentLang==='en'?'Save':'‡≤â‡≤≥‡≤ø‡≤∏‡≤ø'}</button>
          <button class="btn ghost" onclick="loadProfileForm()">${currentLang==='en'?'Reload':'‡≤Æ‡≤∞‡≥Å‡≤≤‡≥ã‡≤°‡≥ç'}</button>
        </div>
        <div id="docProfileMsg" class="muted"></div>
      </div>
    `;
  } catch (e) {
    console.warn('doctor profile not found or failed to fetch, showing empty form', e);
    // show empty form so doctor can enter details for the first time
    area.innerHTML = `
      <div style="display:flex;flex-direction:column;gap:10px">
        <div class="muted">${currentLang==='en'?'No profile found. Please enter your details and Save.':'‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤∞‡≤≤‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤®‡≤ø‡≤Æ‡≥ç‡≤Æ ‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≤Æ‡≥Ç‡≤¶‡≤ø‡≤∏‡≤ø ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤â‡≤≥‡≤ø‡≤∏‡≤ø.'}</div>
        <label data-en="First name" data-kn="‡≤Æ‡≥ä‡≤¶‡≤≤ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å">${currentLang==='en'?'First name':'‡≤Æ‡≥ä‡≤¶‡≤≤ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å'}</label>
        <input id="doc_first_name" type="text" value="" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Last name" data-kn="‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å">${currentLang==='en'?'Last name':'‡≤ï‡≥ä‡≤®‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å'}</label>
        <input id="doc_last_name" type="text" value="" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Specialization" data-kn="‡≤§‡≤ú‡≥ç‡≤û‡≤§‡≥Ü">${currentLang==='en'?'Specialization':'‡≤§‡≤ú‡≥ç‡≤û‡≤§‡≥Ü'}</label>
        <input id="doc_specialization" type="text" value="" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Experience (years)" data-kn="‡≤Ö‡≤®‡≥Å‡≤≠‡≤µ (‡≤µ‡≤∞‡≥ç‡≤∑‡≤ó‡≤≥‡≥Å)">${currentLang==='en'?'Experience (years)':'‡≤Ö‡≤®‡≥Å‡≤≠‡≤µ (‡≤µ‡≤∞‡≥ç‡≤∑‡≤ó‡≤≥‡≥Å)'}</label>
        <input id="doc_experience" type="number" value="0" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef" />
        <label data-en="Bio" data-kn="‡≤ú‡≥Ä‡≤µ‡≤∞‡≥á‡≤ñ‡≥Ü">${currentLang==='en'?'Bio':'‡≤ú‡≥Ä‡≤µ‡≤∞‡≥á‡≤ñ‡≥Ü'}</label>
        <textarea id="doc_bio" rows="4" style="padding:8px;border-radius:8px;border:1px solid #e6e9ef"></textarea>
        <div style="display:flex;gap:8px">
          <button class="btn" onclick="saveDoctorProfile()">${currentLang==='en'?'Save':'‡≤â‡≤≥‡≤ø‡≤∏‡≤ø'}</button>
          <button class="btn ghost" onclick="loadProfileForm()">${currentLang==='en'?'Reload':'‡≤Æ‡≤∞‡≥Å‡≤≤‡≥ã‡≤°‡≥ç'}</button>
        </div>
        <div id="docProfileMsg" class="muted"></div>
      </div>
    `;
  }
}

async function saveDoctorProfile(){
  const payload = {
    first_name: document.getElementById('doc_first_name').value.trim(),
    last_name: document.getElementById('doc_last_name').value.trim(),
    specialization: document.getElementById('doc_specialization').value.trim(),
    experience: parseInt(document.getElementById('doc_experience').value || 0,10) || 0,
    bio: document.getElementById('doc_bio').value.trim()
  };
  const msgEl = document.getElementById('docProfileMsg');
  try {
    const res = await apiFetch(`${BACKEND}/api/doctor/profile`, { method: 'PUT', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
    msgEl.textContent = res.message || (currentLang==='en'?'Saved':'‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
    // Optionally refresh doctors list so parents see updates
    try { await loadDoctors(); } catch(_){}
  } catch (e) {
    console.error(e);
    msgEl.textContent = currentLang==='en' ? 'Save failed' : '‡≤â‡≤≥‡≤ø‡≤∏‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤Ø‡≤ø‡≤§‡≥Å';
  }
}

/* open booking form for a doctor */
function openBookingForm(doctorId) {
  const container = document.getElementById("bookingFormContainer");
  container.innerHTML = `
    <div style="padding:14px;border-radius:10px;border:1px solid #eef3ff;background:#fbfdff">
      <h4 data-en="Book a Consultation" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Book a Consultation':'‡≤∏‡≤≤‡≤π‡≥Ü ‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Æ‡≤æ‡≤°‡≤ø'}</h4>

      <label data-en="Select Baby" data-kn="‡≤∂‡≤ø‡≤∂‡≥Å‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Select Baby':'‡≤∂‡≤ø‡≤∂‡≥Å‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø'}</label>
      <select id="bookBabySelect" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"></select>

      <label style="margin-top:8px" data-en="Choose Date" data-kn="‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Choose Date':'‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø'}</label>
      <input id="bookDate" type="date" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"/>

      <label style="margin-top:8px" data-en="Choose Time" data-kn="‡≤∏‡≤Æ‡≤Ø‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø">${currentLang==='en'?'Choose Time':'‡≤∏‡≤Æ‡≤Ø‡≤µ‡≤®‡≥ç‡≤®‡≥Å ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø'}</label>
      <input id="bookTime" type="time" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"/>

      <label style="margin-top:8px" data-en="Reason (optional)" data_kn="‡≤ï‡≤æ‡≤∞‡≤£ (‡≤ê‡≤ö‡≥ç‡≤õ‡≤ø‡≤ï)" data-kn="‡≤ï‡≤æ‡≤∞‡≤£ (‡≤ê‡≤ö‡≥ç‡≤õ‡≤ø‡≤ï)">${currentLang==='en'?'Reason (optional)':'‡≤ï‡≤æ‡≤∞‡≤£ (‡≤ê‡≤ö‡≥ç‡≤õ‡≤ø‡≤ï)'}</label>
      <textarea id="bookReason" rows="3" style="width:100%;padding:8px;border-radius:8px;margin-top:6px"></textarea>

      <div style="display:flex;gap:8px;margin-top:10px">
        <button class="btn" onclick="confirmBooking(${doctorId})">${currentLang==='en'?'Confirm Booking':'‡≤¨‡≥Å‡≤ï‡≥ç‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç ‡≤¶‡≥É‡≤¢‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø'}</button>
        <button class="btn ghost" onclick="document.getElementById('bookingFormContainer').innerHTML=''">${currentLang==='en'?'Cancel':'‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≤ø'}</button>
      </div>
    </div>
  `;

  // populate baby select
  const sel = document.getElementById("bookBabySelect");
  sel.innerHTML = '';
  babies.forEach(b => {
    const opt = document.createElement("option");
    opt.value = b.id; opt.text = b.name;
    sel.appendChild(opt);
  });
}

/* confirm booking API */
async function confirmBooking(doctorId) {
  const babyId = document.getElementById("bookBabySelect").value;
  const date = document.getElementById("bookDate").value;
  const time = document.getElementById("bookTime").value;
  const reason = document.getElementById("bookReason").value.trim();

  if (!babyId || !date || !time) {
    alert(currentLang==='en' ? 'Please select baby, date and time' : '‡≤¶‡≤Ø‡≤µ‡≤ø‡≤ü‡≥ç‡≤ü‡≥Å ‡≤∂‡≤ø‡≤∂‡≥Å, ‡≤¶‡≤ø‡≤®‡≤æ‡≤Ç‡≤ï ‡≤Æ‡≤§‡≥ç‡≤§‡≥Å ‡≤∏‡≤Æ‡≤Ø ‡≤Ü‡≤Ø‡≥ç‡≤ï‡≥Ü‡≤Æ‡≤æ‡≤°‡≤ø');
    return;
  }

  try {
    const payload = {
      parent_id: userId,
      baby_id: babyId,
      doctor_id: doctorId,
      date,
      time,
      reason
    };
    const res = await apiFetch(`${BACKEND}/api/consultations/book`, { method: "POST", body: JSON.stringify(payload), headers: { "Content-Type": "application/json" }});
    alert(res.message || (currentLang==='en' ? 'Booked' : '‡≤¨‡≥Å‡≤ï‡≥ç ‡≤Ü‡≤ó‡≤ø‡≤¶‡≥Ü'));
    await loadConsultStatus();
    document.getElementById("bookingFormContainer").innerHTML = '';
    showSection('consult_status');
  } catch (e) {
    console.error(e);
    alert(currentLang==='en' ? 'Booking failed' : '‡≤¨‡≥Å‡≤ï‡≥ç‡≤ï‡≤ø‡≤Ç‡≤ó‡≥ç ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* ----------------------------
   Consultation Status (NEW)
   ---------------------------- */
const consultRefreshBtn = document.getElementById("consultRefreshBtn");
const consultCreateBtn = document.getElementById("consultCreateBtn");
const consultSpinner = document.getElementById("consultSpinner");
const consultEmpty = document.getElementById("consultEmpty");
const consultList = document.getElementById("consultList");

consultRefreshBtn?.addEventListener("click", () => loadConsultStatus());
consultCreateBtn?.addEventListener("click", () => {
  // open doctor list section so parent can book
  showSection('doctors');
});

/* call this to load & render consultations for the logged-in parent */
async function loadConsultStatus() {
  // UI reset
  consultSpinner.style.display = "";
  consultEmpty.style.display = "none";
  consultList.style.display = "none";
  consultList.innerHTML = "";

  try {
    // GET consultations for parent. Backend should return an array.
    const res = await apiFetch(`${BACKEND}/api/consultations/status/${userId}`);
    const items = Array.isArray(res) ? res : (res.consultations || res.items || []);

    consultSpinner.style.display = "none";

    if (!items || items.length === 0) {
      consultEmpty.style.display = "";
      consultList.style.display = "none";
      return;
    }

    consultEmpty.style.display = "none";
    consultList.style.display = "";

    // render each consultation card
    items.forEach(item => {
      const card = document.createElement("div");
      card.className = "baby-row";
      card.style.justifyContent = "space-between";
      card.style.alignItems = "center";

      // left html
      const leftHtml = `
        <div style="display:flex;flex-direction:column;gap:6px;">
          <div style="font-weight:700">${escapeHtml(item.doctor_name || item.doctor || (currentLang==='en'?'Doctor':'‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø'))} ‚Ä¢ ${escapeHtml(item.baby_name || '')}</div>
          <div class="muted">${escapeHtml(item.date || item.requested_at || item.created_at || '')} ‚Ä¢ ${escapeHtml(item.rash_type || '')}</div>
        </div>
      `;

      // right box
      const rightDiv = document.createElement("div");
      rightDiv.style.display = "flex";
      rightDiv.style.flexDirection = "column";
      rightDiv.style.gap = "8px";
      rightDiv.style.alignItems = "flex-end";

      // status pill
      const pill = document.createElement("span");
      const statusKey = (item.status || 'pending');
      pill.className = `status-pill ${statusKey}`;
      pill.textContent = translateStatus(statusKey);
      rightDiv.appendChild(pill);

      // actions row
      const actions = document.createElement("div");
      actions.style.display = "flex";
      actions.style.gap = "8px";
      actions.style.marginTop = "6px";

      // View Details
      const viewBtn = document.createElement("button");
      viewBtn.className = "btn ghost";
      viewBtn.textContent = currentLang === "en" ? "View Details" : "‡≤µ‡≤ø‡≤µ‡≤∞‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤®‡≥ã‡≤°‡≤ø";
      viewBtn.onclick = () => window.location.href = `consult_view.html?consult_id=${item.id || item.consultation_id}`;
      actions.appendChild(viewBtn);

      // Chat if accepted
      if (statusKey === "accepted") {
        const chatBtn = document.createElement("button");
        chatBtn.className = "btn";
        chatBtn.textContent = currentLang === "en" ? "Chat" : "‡≤ö‡≤æ‡≤ü‡≥ç";
        chatBtn.onclick = () => {
          window.location.href = `chat.html?consult_id=${item.id || item.consultation_id}&doctor_id=${item.doctor_id || item.doctorId || ''}`;
        };
        actions.appendChild(chatBtn);
      }

      // Cancel if pending
      if (statusKey === "pending") {
        const cancelBtn = document.createElement("button");
        cancelBtn.className = "btn ghost";
        cancelBtn.textContent = currentLang === "en" ? "Cancel" : "‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≤ø";
        cancelBtn.onclick = () => cancelConsult(item.id || item.consultation_id);
        actions.appendChild(cancelBtn);
      }

      rightDiv.appendChild(actions);

      card.innerHTML = leftHtml;
      card.appendChild(rightDiv);

      consultList.appendChild(card);
    });

  } catch (err) {
    consultSpinner.style.display = "none";
    consultEmpty.style.display = "";
    consultEmpty.textContent = currentLang === 'en' ? 'Failed to load consultations' : '‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    console.error("loadConsultStatus error:", err);
  }
}

/* Cancel consultation (pending) */
async function cancelConsult(consultId) {
  if (!confirm(currentLang==='en' ? 'Cancel this consultation?' : '‡≤à ‡≤∏‡≤≤‡≤π‡≥Ü‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≥ã‡≤£‡≤µ‡≥á?')) return;
  try {
    const res = await apiFetch(`${BACKEND}/api/consultations/${consultId}/cancel`, { method: "PUT", headers: { "Content-Type": "application/json" } });
    alert(res.message || (currentLang==='en' ? 'Cancelled' : '‡≤∞‡≤¶‡≥ç‡≤¶‡≥Å‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤Ø‡≤ø‡≤§‡≥Å'));
    await loadConsultStatus();
  } catch (e) {
    console.error(e);
    alert(currentLang==='en' ? 'Action failed' : '‡≤ï‡≥ç‡≤∞‡≤ø‡≤Ø‡≥Ü ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* Translate status label to current language */
function translateStatus(status) {
  if (!status) return '';
  if (currentLang === 'kn') {
    if (status === 'pending') return '‡≤¨‡≤æ‡≤ï‡≤ø‡≤Ø‡≤ø‡≤¶‡≥Ü';
    if (status === 'accepted') return '‡≤∏‡≥ç‡≤µ‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    if (status === 'rejected') return '‡≤®‡≤ø‡≤∞‡≤æ‡≤ï‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    if (status === 'scheduled') return '‡≤®‡≤ø‡≤ó‡≤¶‡≤ø‡≤™‡≤°‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü';
    return status;
  }
  // default english, capitalize first letter
  return status.charAt(0).toUpperCase() + status.slice(1);
}

/* When accepted -> open chat */
let currentChatConsultId = null;
async function openChatForConsult(consultId, doctorId, patientName) {
  // Open inline chat section and load messages for the given consult
  currentChatConsultId = consultId;
  showSection('chat');
  // update chat header
  const title = patientName ? (currentLang==='en'?`Chat ‚Äî ${patientName}`:`‡≤ö‡≤æ‡≤ü‡≥ç ‚Äî ${patientName}`) : (currentLang==='en'?'Chat':'‡≤ö‡≤æ‡≤ü‡≥ç');
  document.getElementById('chatTitle').textContent = title;
  document.getElementById('chatSubtitle').textContent = currentLang==='en' ? `Consultation ${consultId}` : `‡≤∏‡≤≤‡≤π‡≥Ü ${consultId}`;
  document.getElementById('chatInfo').innerHTML = `<div class="muted">${currentLang==='en'?'Loading conversation...':'‡≤∏‡≤Ç‡≤≠‡≤æ‡≤∑‡≤£‡≥Ü‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...'}</div>`;
  await loadChat(consultId);
}

/* Load chat messages for consultation */
async function loadChat(consultId) {
  const messagesEl = document.getElementById('chatMessages');
  messagesEl.innerHTML = `<div class="muted">${currentLang==='en'?'Loading messages...':'‡≤∏‡≤Ç‡≤¶‡≥á‡≤∂‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...'}</div>`;
  try {
    // Backend expected endpoint: GET /api/chats/<consultId>
    const res = await apiFetch(`${BACKEND}/api/chats/${consultId}`);
    const msgs = Array.isArray(res) ? res : (res.messages || []);
    renderChatMessages(msgs);
    // populate chat info
    document.getElementById('chatInfo').innerHTML = `<div><strong>${currentLang==='en'?'Consult ID':'‡≤∏‡≤≤‡≤π‡≥Ü ID'}:</strong> ${escapeHtml(String(consultId))}</div>`;
    // attach send handler
    document.getElementById('chatSendBtn').onclick = () => sendChatMessage(consultId);
    document.getElementById('chatInput').onkeydown = (e) => { if (e.key === 'Enter') sendChatMessage(consultId); };
  } catch (e) {
    console.error('loadChat error', e);
    messagesEl.innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load messages':'‡≤∏‡≤Ç‡≤¶‡≥á‡≤∂‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
    document.getElementById('chatInfo').innerHTML = '';
  }
}

function renderChatMessages(msgs) {
  const messagesEl = document.getElementById('chatMessages');
  if (!msgs || !msgs.length) {
    messagesEl.innerHTML = `<div class="muted">${currentLang==='en'?'No messages yet. Start the conversation.':'‡≤à‡≤ó‡≥Å‡≤µ‡≤∞‡≥Ü‡≤ó‡≥Ç ‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≤Ç‡≤¶‡≥á‡≤∂‡≤ó‡≤≥‡≤ø‡≤≤‡≥ç‡≤≤. ‡≤∏‡≤Ç‡≤≠‡≤æ‡≤∑‡≤£‡≥Ü ‡≤™‡≥ç‡≤∞‡≤æ‡≤∞‡≤Ç‡≤≠‡≤ø‡≤∏‡≤ø.'}</div>`;
    return;
  }
  messagesEl.innerHTML = '';
  msgs.forEach(m => {
    const div = document.createElement('div');
    const cls = (m.sender_role === 'doctor' || m.sender === 'doctor') ? 'doctor-msg' : 'patient-msg';
    div.style.marginBottom = '8px';
    div.innerHTML = `
      <div style="display:flex;flex-direction:column;">
        <div style="font-size:13px; color:var(--muted)">${escapeHtml(m.sender_name || m.sender || '')} ‚Ä¢ ${escapeHtml(m.timestamp || m.sent_at || '')}</div>
        <div style="padding:10px;background:${cls==='doctor-msg'?'#eaf2ff':'#fff'};border-radius:8px;border:1px solid #eef3ff;margin-top:4px">${escapeHtml(m.message || m.text || '')}</div>
      </div>
    `;
    messagesEl.appendChild(div);
  });
  // scroll to bottom
  messagesEl.scrollTop = messagesEl.scrollHeight;
}

async function sendChatMessage(consultId) {
  const input = document.getElementById('chatInput');
  const text = (input.value || '').trim();
  if (!text) return;
  try {
    // POST to backend: /api/chats/<consultId>/send with { sender_role: 'doctor', message }
    const payload = { sender_role: 'doctor', message: text };
    const res = await apiFetch(`${BACKEND}/api/chats/${consultId}/send`, { method: 'POST', body: JSON.stringify(payload), headers: { 'Content-Type': 'application/json' } });
    // optimistic append
    const newMsg = res && res.message ? res.message : { sender_role: 'doctor', sender_name: fullName, message: text, timestamp: new Date().toISOString() };
    // if API returns updated messages list, re-render; else append newMsg
    if (res && Array.isArray(res.messages)) renderChatMessages(res.messages);
    else {
      const messagesEl = document.getElementById('chatMessages');
      const div = document.createElement('div');
      div.style.marginBottom = '8px';
      div.innerHTML = `
        <div style="display:flex;flex-direction:column;">
          <div style="font-size:13px; color:var(--muted)">${escapeHtml(fullName)} ‚Ä¢ ${escapeHtml(newMsg.timestamp || new Date().toISOString())}</div>
          <div style="padding:10px;background:#eaf2ff;border-radius:8px;border:1px solid #eef3ff;margin-top:4px">${escapeHtml(newMsg.message || newMsg.text || '')}</div>
        </div>
      `;
      messagesEl.appendChild(div);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }
    input.value = '';
  } catch (e) {
    console.error('sendChatMessage error', e);
    alert(currentLang==='en' ? 'Failed to send message' : '‡≤∏‡≤Ç‡≤¶‡≥á‡≤∂ ‡≤ï‡≤≥‡≥Å‡≤π‡≤ø‡≤∏‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* =============================
   Small helpers & startup
   ============================= */
function escapeHtml(s) {
  if (s === null || s === undefined) return '';
  return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
}

async function startup() {
  showSection('history'); // open Patients by default for doctors
  await loadPatients();
  await loadDoctors();
  await loadConsultStatus();

  // show/hide chat fab based on any accepted consults
  const anyAccepted = (() => {
    try {
      const list = consultList.querySelectorAll('.baby-row');
      return Array.from(list).some(r => r.textContent.toLowerCase().includes('accepted') || r.innerHTML.includes('Chat'));
    } catch { return false; }
  })();
  if (anyAccepted) document.getElementById("chatFab").hidden = false;
}

/* load everything on start */
startup();
</script>

</body>
</html>
