<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title data-en="Doctor Dashboard" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞ ‡≤°‡≥ç‡≤Ø‡≤æ‡≤∂‡≥ç‚Äå‡≤¨‡≥ã‡≤∞‡≥ç‡≤°‡≥ç">Doctor Dashboard</title>

  <style>
    :root{
      --primary:#1166ee;
      --accent:#4CAF50;
      --bg:#f5f7fb;
      --card:#fff;
      --muted:#6b7280;
      --shadow:0 8px 24px rgba(15,23,42,0.06);
      --radius:12px;
    }
    *{box-sizing:border-box}
    body{ margin:0; font-family:Inter, Arial, sans-serif; background:var(--bg); color:#111827; }

    .topbar{ height:68px; display:flex; align-items:center; gap:16px; padding:0 20px; background:#fff; box-shadow:var(--shadow); position:sticky; top:0; z-index:90;}
    .brand{ display:flex; gap:12px; align-items:center; font-weight:700;}
    .logo{ width:46px; height:46px; border-radius:10px; background:var(--primary); color:#fff; display:flex; align-items:center; justify-content:center; font-weight:700; box-shadow:0 3px 8px rgba(0,0,0,0.08); }
    .top-actions{ margin-left:auto; display:flex; gap:12px; align-items:center; }

    .btn{ background:var(--primary); color:white; border:none; padding:8px 12px; border-radius:10px; cursor:pointer; font-weight:600; }
    .btn.ghost{ background:#fff; color:#111; border:1px solid #e6e9ef; box-shadow:none; }
    .btn.warn{ background:#ef4444; }

    .layout{ display:flex; gap:24px; padding:26px; max-width:1200px; margin:20px auto; align-items:flex-start; }

    .sidebar{ width:260px; background:var(--card); border-radius:var(--radius); padding:18px; box-shadow:var(--shadow); position:sticky; top:88px; height:calc(100vh - 120px); display:flex; flex-direction:column; gap:12px; }
    .nav-item{ display:flex; gap:12px; align-items:center; padding:10px; border-radius:10px; color:#374151; cursor:pointer; text-decoration:none; }
    .nav-item:hover{ background:#f3f6ff; color:var(--primary); }
    .nav-item.active{ background:#eaf2ff; color:var(--primary); font-weight:700; }

    .main{ flex:1; display:flex; flex-direction:column; gap:18px; min-height:60vh; }
    .card{ background:var(--card); padding:18px; border-radius:12px; box-shadow:var(--shadow); }
    .request-card{ border:1px solid #eef3ff; padding:12px; margin-bottom:10px; border-radius:10px; background:#fff; display:flex; justify-content:space-between; align-items:center; gap:12px; }
    .muted{ color:var(--muted); font-size:13px; }

    @media (max-width:960px){
      .layout{ padding:12px; margin:12px; flex-direction:column; }
      .sidebar{ width:100%; height:auto; position:relative; top:0; flex-direction:row; overflow:auto; padding:12px; gap:8px; }
    }

    .chat-fab{ position:fixed; right:18px; bottom:18px; width:56px; height:56px; border-radius:50%; background:#10b981; color:#fff; display:flex; align-items:center; justify-content:center; box-shadow:0 6px 20px rgba(16,185,129,0.18); cursor:pointer; z-index:200; }
  </style>
</head>
<body>

  <div class="topbar">
    <div class="brand">
      <div class="logo">üë©‚Äç‚öïÔ∏è</div>
      <div>
        <div style="font-size:14px" data-en="Smart Baby Skin Scanner" data-kn="‡≤∏‡≥ç‡≤Æ‡≤æ‡≤∞‡≥ç‡≤ü‡≥ç ‡≤¨‡≥á‡≤¨‡≤ø ‡≤∏‡≥ç‡≤ï‡≤ø‡≤®‡≥ç ‡≤∏‡≥ç‡≤ï‡≥ç‡≤Ø‡≤æ‡≤®‡≤∞‡≥ç">Smart Baby Skin Scanner</div>
        <div style="font-size:12px;color:var(--muted)" id="welcomeText">Doctor</div>
      </div>
    </div>

    <div class="top-actions">
      <select id="languageSwitcher">
        <option value="en">English</option>
        <option value="kn">‡≤ï‡≤®‡≥ç‡≤®‡≤°</option>
      </select>

      <button class="btn ghost" onclick="showSection('requests')" data-en="Requests" data-kn="‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø‡≤ó‡≤≥‡≥Å">Requests</button>
      <button class="btn" onclick="logout()" data-en="Logout" data-kn="‡≤≤‡≤æ‡≤ó‡≥å‡≤ü‡≥ç">Logout</button>
    </div>
  </div>

  <div class="layout">
    <aside class="sidebar" role="navigation" aria-label="Doctor menu">
      <div style="font-weight:700" data-en="Doctor Menu" data-kn="‡≤µ‡≥à‡≤¶‡≥ç‡≤Ø‡≤∞ ‡≤Æ‡≥Ü‡≤®‡≥Å">Doctor Menu</div>

      <div class="nav-item active" id="nav_requests" onclick="showSection('requests')">
        <span>üì•</span><span data-en="Requests" data-kn="‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø‡≤ó‡≤≥‡≥Å">Requests</span>
      </div>

      <div class="nav-item" id="nav_records" onclick="showSection('records')">
        <span>üìÑ</span><span data-en="Records" data_kn="‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç‡≤ó‡≤≥‡≥Å" data-kn="‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç‡≤ó‡≤≥‡≥Å">Records</span>
      </div>

      <div class="nav-item" id="nav_schedule" onclick="showSection('schedule')">
        <span>üìÖ</span><span data-en="Schedule" data_kn="‡≤µ‡≤æ‡≤∞‡≥ç‡≤∑‡≤ø‡≤ï" data-kn="‡≤µ‡≥á‡≤≥‡≤æ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø">Schedule</span>
      </div>

      <div class="nav-item" id="nav_profile" onclick="showSection('profile')">
        <span>üë§</span><span data-en="Profile" data-kn="‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç">Profile</span>
      </div>

      <div style="margin-top:auto; font-size:13px; color:var(--muted);">
        <div data-en="Logged as" data-kn="‡≤≤‡≤æ‡≤ó‡≤ø‡≤®‡≥ç ‡≤Ü‡≤ó‡≤ø‡≤∞‡≥Å‡≤µ ‡≤™‡≤æ‡≤§‡≥ç‡≤∞">Logged as</div>
        <strong id="docName">Doctor</strong>
      </div>
    </aside>

    <main class="main">
      <!-- Requests (default) -->
      <section id="section_requests" class="card">
        <h1 data-en="Consultation Requests" data-kn="‡≤∏‡≤≤‡≤π‡≥Ü ‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø‡≤ó‡≤≥‡≥Å">Consultation Requests</h1>
        <p class="muted" data-en="Review, accept or schedule incoming consultation requests" data-kn="‡≤á‡≤®‡≥ç‡≤™‡≥Å‡≤ü‡≥ç‚Äå ‡≤∏‡≤≤‡≤π‡≥Ü ‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤™‡≤∞‡≤ø‡≤∂‡≥Ä‡≤≤‡≤ø‡≤∏‡≤ø, ‡≤∏‡≥ç‡≤µ‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø ‡≤Ö‡≤•‡≤µ‡≤æ ‡≤µ‡≥á‡≤≥‡≤æ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø ‡≤Æ‡≤æ‡≤°‡≤ø">Review, accept or schedule incoming consultation requests</p>

        <div id="requestsContainer" style="margin-top:12px"></div>
      </section>

      <!-- Records -->
      <section id="section_records" class="card" style="display:none;">
        <h1 data-en="Patient Records" data-kn="‡≤∞‡≥ã‡≤ó‡≤ø‡≤Ø ‡≤¶‡≤æ‡≤ñ‡≤≤‡≥Ü‡≤ó‡≤≥‡≥Å">Patient Records</h1>
        <div id="recordsContainer" style="margin-top:12px"></div>
      </section>

      <!-- Schedule -->
      <section id="section_schedule" class="card" style="display:none;">
        <h1 data-en="My Schedule" data-kn="‡≤®‡≤®‡≥ç‡≤® ‡≤µ‡≥á‡≤≥‡≤æ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø">My Schedule</h1>
        <div id="scheduleContainer" style="margin-top:12px"></div>
      </section>

      <!-- Profile -->
      <section id="section_profile" class="card" style="display:none;">
        <h1 data-en="Profile" data-kn="‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç">Profile</h1>
        <div id="profileArea" style="margin-top:12px"></div>
      </section>
    </main>
  </div>

  <div id="chatFab" class="chat-fab" title="Open Chat" onclick="openChat()" hidden>üí¨</div>

<script>
/* CONFIG */
const BACKEND = "http://127.0.0.1:5000"; // change if needed
const token = localStorage.getItem("token");
const role = localStorage.getItem("role");
const userId = localStorage.getItem("user_id");
const fullName = localStorage.getItem("full_name") || "Doctor";
let currentLang = localStorage.getItem("lang") || "en";

/* PROTECTION */
if (!token) window.location.href = "login.html";
if (role !== "doctor") window.location.href = "home.html";

/* UI init */
document.getElementById("docName").textContent = fullName;
document.getElementById("welcomeText").textContent = currentLang === "en" ? `Dr. ${fullName}` : `‡≤°‡≤æ. ${fullName}`;
document.getElementById("languageSwitcher").value = currentLang;

/* MULTI-LANGUAGE */
function setLanguage(lang){
  currentLang = lang;
  localStorage.setItem("lang", lang);
  document.querySelectorAll("[data-en]").forEach(el => el.textContent = el.getAttribute("data-" + lang));
  document.querySelectorAll("[data-en-placeholder]").forEach(el => el.placeholder = el.getAttribute(`data-${lang}-placeholder`));
  document.getElementById("welcomeText").textContent = lang === "en" ? `Dr. ${fullName}` : `‡≤°‡≤æ. ${fullName}`;
}
document.getElementById("languageSwitcher").addEventListener("change", (e) => setLanguage(e.target.value));
setLanguage(currentLang);

/* SECTION NAV */
function hideAll(){
  ["requests","records","schedule","profile"].forEach(s => {
    const el = document.getElementById("section_" + s);
    if (el) el.style.display = (s === 'requests' ? '' : 'none'); // default show requests
    const nav = document.getElementById("nav_" + s);
    if (nav) nav.classList.remove("active");
  });
}
function showSection(name){
  hideAll();
  const section = document.getElementById("section_" + name);
  if (section) section.style.display = "";
  const nav = document.getElementById("nav_" + name);
  if (nav) nav.classList.add("active");
}

/* AUTH FETCH helper */
async function apiFetch(url, opts = {}) {
  opts.headers = opts.headers || {};
  opts.headers["Authorization"] = `Bearer ${token}`;
  try {
    const r = await fetch(url, opts);
    if (!r.ok) {
      const txt = await r.text();
      try { const j = JSON.parse(txt); throw new Error(j.message || txt); } catch { throw new Error(txt); }
    }
    return await r.json();
  } catch (err) {
    console.error("API error", err);
    throw err;
  }
}

/* LOAD REQUESTS */
async function loadRequests(){
  const container = document.getElementById("requestsContainer");
  container.innerHTML = `<div class="muted">${currentLang==='en'?'Loading...':'‡≤≤‡≥ã‡≤°‡≥Ü‡≥ñ‡≤Ç‡≤ó‡≥ç...'}</div>`;
  try {
    const data = await apiFetch(`${BACKEND}/api/consultations/doctor`);
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = `<div class="muted">${currentLang==='en'?'No consultation requests.':'‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤∏‡≤≤‡≤π‡≥Ü ‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø‡≤ó‡≤≥‡≥Å ‡≤á‡≤≤‡≥ç‡≤≤.'}</div>`;
      return;
    }
    container.innerHTML = "";
    data.forEach(req => {
      const card = document.createElement("div");
      card.className = "request-card";
      card.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${req.baby_name} ‚Ä¢ ${req.parent_name || ''}</div>
          <div class="muted">${req.requested_at} ‚Ä¢ ${req.rash_type}</div>
          <div style="margin-top:8px" class="muted">${req.reason || ''}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end;">
          <div style="display:flex;gap:6px">
            <button class="btn ghost" onclick="viewRecord(${req.record_id})" data-en="View Record" data-kn="‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤ø‡≤∏‡≤ø">${currentLang==='en'?'View Record':'‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤ø‡≤∏‡≤ø'}</button>
            <button class="btn" onclick="updateStatus(${req.consultation_id}, 'accepted')" data-en="Accept" data-kn="‡≤∏‡≥ç‡≤µ‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø">${currentLang==='en'?'Accept':'‡≤∏‡≥ç‡≤µ‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø'}</button>
            <button class="btn warn" onclick="updateStatus(${req.consultation_id}, 'rejected')" data-en="Reject" data_kn="‡≤§‡≤ø‡≤∞‡≤∏‡≥ç‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø" data-kn="‡≤§‡≤ø‡≤∞‡≤∏‡≥ç‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø">${currentLang==='en'?'Reject':'‡≤§‡≤ø‡≤∞‡≤∏‡≥ç‡≤ï‡≤∞‡≤ø‡≤∏‡≤ø'}</button>
          </div>
          <div style="font-size:13px;color:var(--muted)">${req.status}</div>
        </div>
      `;
      container.appendChild(card);
    });
  } catch (e) {
    console.error(e);
    container.innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load requests':'‡≤µ‡≤ø‡≤®‡≤Ç‡≤§‡≤ø‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

/* UPDATE STATUS */
async function updateStatus(id, status){
  try {
    const res = await apiFetch(`${BACKEND}/api/consultations/${id}/update`, {
      method: "PUT",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ status })
    });
    alert(res.message || (currentLang==='en'?'Updated':'‡≤®‡≤µ‡≥Ä‡≤ï‡≤∞‡≤ø‡≤∏‡≤≤‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'));
    loadRequests();
    loadSchedule(); // refresh schedule if accepted
  } catch (e) {
    console.error(e);
    alert(currentLang==='en'?'Action failed':'‡≤ï‡≥ç‡≤∞‡≤Æ ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü');
  }
}

/* VIEW PATIENT RECORD */
function viewRecord(recordId){
  // open record details page or modal
  window.location.href = `doctor_record_view.html?record_id=${recordId}`;
}

/* LOAD RECORDS */
async function loadRecords() {
  const container = document.getElementById("recordsContainer");
  container.innerHTML = `<div class="muted">${currentLang==='en'?'Loading...':'‡≤≤‡≥ã‡≤°‡≥Ü‡≥ñ‡≤Ç‡≤ó‡≥ç...'}</div>`;
  try {
    const data = await apiFetch(`${BACKEND}/api/records`);
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = `<div class="muted">${currentLang==='en'?'No records found':'‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤¶‡≤æ‡≤ñ‡≤≤‡≥Ü‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤ï‡≤Ç‡≤°‡≥Å‡≤¨‡≤Ç‡≤¶‡≤ø‡≤≤‡≥ç‡≤≤'}</div>`;
      return;
    }
    container.innerHTML = "";
    data.forEach(r => {
      const div = document.createElement("div");
      div.className = "request-card";
      div.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${r.baby_name} ‚Ä¢ ${r.parent_name || ''}</div>
          <div class="muted">${r.created_at} ‚Ä¢ ${r.rash_type}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn ghost" onclick="viewRecord(${r.id})">${currentLang==='en'?'Open':'‡≤§‡≥Ü‡≤∞‡≥Ü‡≤Ø‡≤ø‡≤∞‡≤ø'}</button>
        </div>
      `;
      container.appendChild(div);
    });
  } catch (e) {
    console.error(e);
    container.innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load records':'‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç‡≤ó‡≤≥‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

/* LOAD SCHEDULE */
async function loadSchedule(){
  const container = document.getElementById("scheduleContainer");
  container.innerHTML = `<div class="muted">${currentLang==='en'?'Loading schedule...':'‡≤µ‡≥á‡≤≥‡≤æ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≤æ‡≤ó‡≥Å‡≤§‡≥ç‡≤§‡≤ø‡≤¶‡≥Ü...'}</div>`;
  try {
    const data = await apiFetch(`${BACKEND}/api/consultations/schedule/${userId}`);
    if (!Array.isArray(data) || data.length === 0) {
      container.innerHTML = `<div class="muted">${currentLang==='en'?'No scheduled consultations':'‡≤Ø‡≤æ‡≤µ‡≥Å‡≤¶‡≥á ‡≤®‡≤ø‡≤ó‡≤¶‡≤ø‡≤§ ‡≤∏‡≤≤‡≤π‡≥Ü‡≤ó‡≤≥‡≥Å ‡≤á‡≤≤‡≥ç‡≤≤'}</div>`;
      return;
    }
    container.innerHTML = "";
    data.forEach(s => {
      const div = document.createElement("div");
      div.className = "request-card";
      div.innerHTML = `
        <div style="flex:1">
          <div style="font-weight:700">${s.baby_name} ‚Ä¢ ${s.parent_name || ''}</div>
          <div class="muted">${s.date} ${s.time}</div>
        </div>
        <div style="display:flex;flex-direction:column;gap:8px">
          <button class="btn" onclick="openChatForConsult(${s.id}, ${s.parent_id})">${currentLang==='en'?'Chat':'‡≤ö‡≤æ‡≤ü‡≥ç'}</button>
          <button class="btn ghost" onclick="viewRecord(${s.record_id})">${currentLang==='en'?'View Record':'‡≤∞‡≥Ü‡≤ï‡≤æ‡≤∞‡≥ç‡≤°‡≥ç ‡≤µ‡≥Ä‡≤ï‡≥ç‡≤∑‡≤ø‡≤∏‡≤ø'}</button>
        </div>
      `;
      container.appendChild(div);
    });
    // show chat fab if any scheduled
    document.getElementById("chatFab").hidden = data.length === 0;
  } catch (e) {
    console.error(e);
    container.innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load schedule':'‡≤µ‡≥á‡≤≥‡≤æ‡≤™‡≤ü‡≥ç‡≤ü‡≤ø‡≤Ø‡≤®‡≥ç‡≤®‡≥Å ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

/* PROFILE */
async function loadProfile(){
  const area = document.getElementById("profileArea");
  try {
    const doc = await apiFetch(`${BACKEND}/api/doctors/me`);
    area.innerHTML = `
      <div style="display:flex;gap:18px;align-items:flex-start;">
        <div style="width:140px;height:140px;border-radius:12px;background:#f1f5f9;display:flex;align-items:center;justify-content:center;font-weight:700">${(doc.first_name||'D').charAt(0)}</div>
        <div style="flex:1">
          <h3 style="margin:0">${doc.first_name} ${doc.last_name || ''}</h3>
          <div class="muted">${doc.specialization || ''} ‚Ä¢ ${doc.experience || ''} yrs</div>
          <p style="margin-top:10px">${doc.bio || ''}</p>
        </div>
      </div>
    `;
  } catch (e) {
    console.error(e);
    area.innerHTML = `<div class="muted">${currentLang==='en'?'Failed to load profile':'‡≤™‡≥ç‡≤∞‡≥ä‡≤´‡≥à‡≤≤‡≥ç ‡≤≤‡≥ã‡≤°‡≥ç ‡≤Æ‡≤æ‡≤°‡≤≤‡≥Å ‡≤µ‡≤ø‡≤´‡≤≤‡≤µ‡≤æ‡≤ó‡≤ø‡≤¶‡≥Ü'}</div>`;
  }
}

/* CHAT */
function openChat(){
  window.location.href = `chat.html?doctor_id=${userId}`;
}
function openChatForConsult(consultId, parentId){
  window.location.href = `chat.html?consult_id=${consultId}&parent_id=${parentId}`;
}

/* LOGOUT */
function logout(){
  localStorage.removeItem("token");
  localStorage.removeItem("role");
  localStorage.removeItem("user_id");
  localStorage.removeItem("full_name");
  window.location.href = "login.html";
}

/* STARTUP */
async function startup(){
  showSection('requests'); // default
  await loadRequests();
  await loadRecords();
  await loadSchedule();
  await loadProfile();
}
startup();

</script>
</body>
</html>
